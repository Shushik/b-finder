/**
 * b-finder script
 *
 * @version 3.0
 * @author  Shushik <silkleopard@yandex.ru>
 * @page    http://github.com/Shushik/b-finder
 *
 * @requires jQuery 1.6+
 */
;(function(b){function y(){var c=b(b.browser.msie?document.body:window),a=null,d=this.data("params"),e=this.data("handlers");d.finder_static&&this.addClass("b-finder_static_yes");a=b(".b-finder__cols_id_"+d.finder_id,this);c.bind("keydown.finder_keydown",function(a){var c=b(".b-finder"),d=b(".b-finder__cols_active_yes"),e=d.hasClass("b-finder__cols_mode_search")?"search":"watch",g=a.keyCode,j={38:"top",39:"right",40:"bottom",37:"left"};j[g]?(a.preventDefault(),z.call(d,a,j[g])):13==g?t.call(o.call(d, "search"==e?"first":"last"),a):27==g&&"search"==e?(a.stopPropagation(),s.call(d.get(0),a)):27==g&&q.call(c)});b(".b-finder__hat",this).html(d.finder_lang&&d.finder_lang.hat?d.finder_lang.hat:"&nbsp;");b(".b-finder__hint",this).html(d.finder_lang&&d.finder_lang.hint?d.finder_lang.hint:"&nbsp;");b(".b-finder__field",this).attr("placeholder",d.finder_lang&&d.finder_lang.search?d.finder_lang.search:"");b(".b-finder__filter",this).attr("title",d.finder_lang&&d.finder_lang.selected?d.finder_lang.selected: "");0!=a.length?u.call(a):d.finder_async?e.load.call(this,d,{done:b.proxy(v,this)}):a=v.call(this,e.load.call(this,d))}function q(){var c=this.data("params"),a=this.data("handlers");b(b.browser.msie?document.body:window).unbind("keydown.finder_keydown");this.addClass("b-finder_hidden_yes").removeClass("b-finder_static_yes");b(".b-finder__cols_active_yes",this).removeClass("b-finder__cols_active_yes");a.hide&&a.hide.call(this,c)}function A(){var c=b(this),a=b('<table class="b-finder b-finder_hidden_yes"><tr><td class="b-finder__valign"><div class="b-finder__window"><div class="b-finder__search"><div class="b-finder__filter"></div><div class="b-finder__clear">\u00d7</div><input class="b-finder__field" autocomplete="off" ></div><div class="b-finder__hide">\u00d7</div><div class="b-finder__hat"></div><div class="b-finder__hint"></div></div></td></tr></table>'), d=b(".b-finder__window",a),e=b(".b-finder__hide",d);0<c.length?c.replaceWith(a):b("body").append(a);a.click(function(){q.call(b(this))});e.click(function(){q.call(b(this).closest(".b-finder"))});d.click(function(a){a.stopPropagation()});d.delegate(".b-finder__field","keydown",function(a){var c=b(this),d=c.data("search"),a=a.keyCode;d&&clearTimeout(d);c.hasClass("b-finder__field")&&(40==a?c.blur():27!=a&&c.data("b_finder_search",setTimeout(b.proxy(w,this),300)))});d.delegate(".b-finder__filter","click", function(a){var c=b(this);c.hasClass("b-finder__filter_active_yes")?(c.removeClass("b-finder__filter_active_yes"),s.call(this,a)):(c.addClass("b-finder__filter_active_yes"),w.call(this))});d.delegate(".b-finder__clear","click",s);d.delegate(".b-finder__row","click",function(a){k.call(this,a,!0)});d.delegate(".b-finder__row","dblclick",function(a){t.call(this,a)});return a}function u(){var c=this.closest(".b-finder"),a=c.data("handlers"),d=c.data("params"),b=null;this.data("prescroll",!0);b=o.call(this); k.call(b,null,!0);c.removeClass("b-finder_hidden_yes");a.show&&a.show.call(c,d)}function v(c){var a=4,d=0,e=0,e=b(".b-finder__hat",this),f=b('<div class="b-finder__cols"></div>'),i=b('<div class="b-finder__scroll"></div>'),h=b('<div class="b-finder__found"></div>'),r={},g={},j=this.data("params");this.data("handlers");var l,k,n,p,m;if(j.finder_cols&&5>j.finder_cols&&0<j.finder_cols)a=j.finder_cols;e.after(f.addClass("b-finder__cols_id_"+j.finder_id).addClass("b-finder__cols_x_"+a).addClass("b-finder__cols_mode_watch")); f.append(i);e=c.length;for(p=0;p<e;p++){m=c[p];n=m.level;k=m.name;l="root";a=m.id;if(m.parentId)l=m.parentId;else if(m.parent_id)l=m.parent_id;else if(m.pid)l=m.pid;r[n]||(r[n]=x.call(i,n),d<n&&(d=n));g[l]||(g[l]=B.call(r[n],l));l=C.call(g[l],a,l,k);j.finder_selected&&-1<b.inArray(a,j.finder_selected)&&l.addClass("b-finder__row_expanded_yes").addClass("b-finder__row_selected_yes")}for(p in g)b(".b-finder__row_id_"+g[p].data("id"),f).addClass("b-finder__row_expandable_yes");b(".b-finder__col_level_1", f).append(h);j.finder_holder||x.call(i,d+1);u.call(f)}function x(c){var c=b('<div class="b-finder__col"></div>').addClass("b-finder__col_level_"+c).data("level",c),a=this.css("width").replace("px","")-0;this.append(c);a+=c.css("width").replace("px","")-0+(c.css("margin-right").replace("px","")-0)+(c.css("margin-left").replace("px","")-0);this.css("width",a+"px");return c}function B(c){var a=b('<div class="b-finder__group b-finder__group_id_'+c+'"></div>').data("id",c);"root"==c&&a.addClass("b-finder__group_expanded_yes"); this.append(a);return a}function C(c,a,d){c=b('<div class="b-finder__row b-finder__row_id_'+c+'"></div>').text(d).attr("title",d.toLowerCase()).data({id:c,pid:a});this.append(c);return c}function k(c,a,d){var a=a||!1,d=d||!1,e=b(this),f=e.closest(".b-finder__group,.b-finder__found"),i=e.closest(".b-finder__col"),h=i.closest(".b-finder__scroll").closest(".b-finder__cols"),r=h.closest(".b-finder"),g=e.hasClass("b-finder__row_expandable_yes")?!0:!1,j=e.data("id"),l=e.data("pid"),o=i.data("level");h.data("prescroll"); var n=h.hasClass("b-finder__cols_mode_search")?"search":"watch",p=o-2,m=e.data("row"),q="search"==n?null:b(".b-finder__row_id_"+l,h).get(0),s=r.data("handlers");a&&(s.click&&!m&&s.click.call(this,c,{id:j,pid:l,next:o+1,name:e.text(),expandable:g},r.data("params")),b(".b-finder__group_expanded_yes",h).removeClass("b-finder__group_expanded_yes"),b(".b-finder__row_expanded_yes",h).removeClass("b-finder__row_expanded_yes"),g&&b(".b-finder__group_id_"+j,h).addClass("b-finder__group_expanded_yes"),h.addClass("b-finder__cols_active_yes"), "search"==n&&m&&k.call(m,c,!0));e.addClass("b-finder__row_expanded_yes");m&&b(m).addClass("b-finder__row_expanded_yes");"watch"==n&&f.addClass("b-finder__group_expanded_yes");"watch"==n&&a&&!d&&h.data("b_finder_scroll",setTimeout(function(){h.scrollLeft((i.css("width").replace("px","")-0+(i.css("margin-left").replace("px","")-0)+(i.css("margin-right").replace("px","")-0))*p)},200));if("watch"==n&&!a||c&&38==c.keyCode||c&&40==c.keyCode)i.scrollTop(e.offset().top-f.offset().top),1==o&&h.removeData("prescroll"); "watch"==n&&1<o&&k.call(q,c,!1)}function t(c){var a=b(this),d=a.closest(".b-finder__group"),e=a.closest(".b-finder__col"),f=e.closest(".b-finder__cols"),i=f.closest(".b-finder"),h=i.data("params"),i=i.data("handlers"),k=h.finder_multiple&&c.ctrlKey||h.finder_multiple&&c.metaKey?!1:!0,g=f.data("scroll"),e=e.data("level")-0+1,j=a.hasClass("b-finder__row_selected_yes")?"cancel":"approve",d=d.data("id"),l=a.data("id");a.data("row");g&&clearTimeout(g);i.dblclick&&(k&&"approve"==j&&f.data("clear",!0),"cancel"== j&&a.addClass("b-finder__row_cancel_yes"),a.addClass("b-finder__row_loading_yes"),i.dblclick.call(this,c,{hide:b.proxy(q,f.closest(".b-finder")),done:b.proxy(D,a.get(0)),undone:b.proxy(E,a.get(0))},{id:l,pid:d,next:e,name:a.text(),action:j,expandable:a.hasClass("b-finder__row_expandable_yes")?!0:!1},h))}function z(c,a){var d=this.hasClass("b-finder__cols_mode_search")?"search":"watch",e=b(o.call("search"==d?b(".b-finder__found",this):this,"last")),f=null;if("top"==a)f=e.prev();else if("bottom"==a)f= e.next();else if("watch"==d&&e.hasClass("b-finder__row_expandable_yes")&&"right"==a||"watch"==d&&"left"==a&&"root"!=e.data("pid"))"right"==a?f=b(o.call(b(".b-finder__group_expanded_yes:last",this),"first")):(e.removeClass("b-finder__row_expanded_yes"),f=b(".b-finder__row_id_"+e.data("pid"),this));this.data("prescroll",!0);f&&0<f.length&&k.call(f.get(0),c,!0)}function o(c){var c=c||"first",a=null;(a=b(".b-finder__row_expanded_yes:"+c,this).get(0))||(a=this.hasClass("b-finder__group")||this.hasClass("b-finder__found")? b(".b-finder__row",this).get(0):b(".b-finder__group_id_root .b-finder__row:"+c,this).get(0));return a}function D(){var c=b(this),a=c.closest(".b-finder__cols"),d=a.data("clear"),e=c.data("row");d&&(b(".b-finder__row_selected_yes",a).removeClass("b-finder__row_selected_yes"),a.removeData("clear"));c.hasClass("b-finder__row_cancel_yes")?(c.removeClass("b-finder__row_selected_yes"),e&&b(e).removeClass("b-finder__row_selected_yes")):(c.addClass("b-finder__row_selected_yes"),e&&b(e).addClass("b-finder__row_selected_yes")); c.removeClass("b-finder__row_loading_yes").removeClass("b-finder__row_cancel_yes");k.call(this,null,!0)}function E(){this.removeClass("b-finder__row_loading_yes");k.call(this,null,!0)}function w(){var c=b(this),a=b(".b-finder__cols_active_yes",c.closest(".b-finder__window")),d=null,e=null,f=b(".b-finder__found",a).empty(),i=0,h=0,k="",g="";a.removeClass("b-finder__cols_mode_watch").addClass("b-finder__cols_mode_search").scrollLeft(0);c.hasClass("b-finder__field")?(g=c.val(),h=g.length,e=0<h?b('.b-finder__row[title^="'+ g.toLowerCase()+'"],.b-finder__row[title*=" '+g.toLowerCase()+'"]',a):b(".b-finder__row",a)):e=b(".b-finder__row_selected_yes",a);e&&0<e.length&&e.each(function(){d=b(this).clone().removeClass("b-finder__row_expandable_yes").removeClass("b-finder__row_expanded_yes").removeClass("b-finder__row_loading_yes").data("row",this);0==i&&d.addClass("b-finder__row_expanded_yes");0<h&&d.html(d.text().replace(RegExp("(^| )("+g+")","i"),'$1<span class="b-finder__highlight">$2</span>'));(k=b(".b-finder__group .b-finder__row_id_"+ b(this).data("pid"),a).text())&&d.prepend(k+" > ");f.append(d);i++})}function s(c){var a=b(this).closest(".b-finder"),a=b(".b-finder__window",a),d=b(".b-finder__cols_active_yes",a),e=null;d.removeClass("b-finder__cols_mode_search").addClass("b-finder__cols_mode_watch");b(".b-finder__found",d).empty();b(".b-finder__field",a).val("").blur();b(".b-finder__filter",a).removeClass("b-finder__filter_active_yes");e=o.call(d,"last");k.call(e,c)}b.fn.finder=function(c,a,b){var b=b||{},a=a||{items_load:function(){return[]}}, e=this;b.finder_id=c;if(0==e.length||!e.hasClass("b-finder"))e=A.call(e);e.hasClass("b-finder_hidden_yes")?(e.data("params",b),e.data("handlers",a),y.call(e),e.focus()):q.call(e);return this}})(jQuery);