/**
 * Finder
 *
 * @version 3.0
 * @author  Shushik <silkleopard@yandex.ru>
 */
(function(d){function w(c,a,b){var e=d(window),f=d(".b-finder__cols_id_"+c,this),g=null;e.bind("keydown.b_finder_hide",function(a){var c=d(".b-finder"),b=d(".b-finder__cols_active_yes"),e=b.hasClass("b-finder__cols_mode_search")?"search":"watch",f=a.keyCode;f==27&&e=="search"?(a.stopPropagation(),r.call(b.get(0),a)):f==27&&p.call(c)});d(".b-finder__hat",this).html(b.finder_lang&&b.finder_lang.hat?b.finder_lang.hat:"&nbsp;");d(".b-finder__hint",this).html(b.finder_lang&&b.finder_lang.hint?b.finder_lang.hint: "&nbsp;");d(".b-finder__field",this).attr("placeholder",b.finder_lang&&b.finder_lang.search?b.finder_lang.search:"");d(".b-finder__filter",this).attr("title",b.finder_lang&&b.finder_lang.selected?b.finder_lang.selected:"");f.length==0&&(f=x.call(this,c,a,b));f.data("b_finder_prescroll",true);g=s.call(f);d(g).mousedown();this.removeClass("b-finder_hidden_yes")}function p(){d(window).unbind("keydown.b_finder_hide");this.addClass("b-finder_hidden_yes");d(".b-finder__cols_active_yes",this).removeClass("b-finder__cols_active_yes")} function y(){var c=d('<table class="b-finder b-finder_hidden_yes"><tr><td class="b-finder__valign"><div class="b-finder__window"><div class="b-finder__search"><div class="b-finder__filter"></div><div class="b-finder__clear">\u00d7</div><input class="b-finder__field" type="search"></div><div class="b-finder__hide">\u00d7</div><div class="b-finder__hat"></div><div class="b-finder__hint"></div></div></td></tr></table>'),a=d(".b-finder__window",c),b=d(".b-finder__hide",a);d("body").append(c);c.click(function(){p.call(d(this))}); b.click(function(){p.call(d(this).closest(".b-finder"))});a.click(function(a){a.stopPropagation()});a.delegate(".b-finder__field","keydown",function(a){var b=d(this),c=b.data("b_finder_search"),a=a.keyCode;c&&clearTimeout(c);b.hasClass("b-finder__field")&&a!=37&&a!=38&&a!=39&&a!=40&&a!=27&&b.data("b_finder_search",setTimeout(d.proxy(t,this),300))});a.delegate(".b-finder__filter","click",function(a){var b=d(this);b.hasClass("b-finder__filter_active_yes")?(b.removeClass("b-finder__filter_active_yes"), r.call(this,a)):(b.addClass("b-finder__filter_active_yes"),t.call(this))});a.delegate(".b-finder__clear","click",r);a.delegate(".b-finder__col","mouseover",function(){d(this).focus()});a.delegate(".b-finder__row","mousedown",function(a){var b=d(this),c=b.closest(".b-finder__cols"),h=this,i=c.data("clicked"),k=b.closest(".b-finder__found").length>0?b.data("b_finder_link"):null;i?i&&(i&&(clearInterval(i),c.removeData("clicked")),k&&u.call(k,a),u.call(h,a)):c.data("clicked",setTimeout(function(){c.removeData("clicked"); k&&q.call(k,a,true);q.call(h,a,true)},200))});return c}function x(c,a,b){var e=b.finder_cols&&typeof b.finder_cols=="number"&&b.finder_cols<5&&b.finder_cols>0?b.finder_cols:4,f=0,g=d(".b-finder__hat",this),h=d('<div class="b-finder__cols"></div>'),i=d('<div class="b-finder__scroll"></div>'),k=d('<div class="b-finder__found"></div>'),n={},o={},m,l,j;g.after(h.addClass("b-finder__cols_id_"+c).addClass("b-finder__cols_x_"+e).addClass("b-finder__cols_mode_watch").data("b_finder_params",b));for(l in a)h.data("b_finder_"+ l,a[l]);h.append(i);a=a.load(b);for(l=0;l<a.total;l++){j=a.items[l];m=j.level;g=j.name;e="root";c=j.id;if(j.parentId)e=j.parentId;else if(j.parent_id)e=j.parent_id;else if(j.pid)e=j.pid;n[m]||(n[m]=v.call(i,m),f<m&&(f=m));o[e]||(o[e]=z.call(n[m],e));e=A.call(o[e],c,e,g);b.finder_selected&&b.finder_selected.indexOf(c)>-1&&e.addClass("b-finder__row_selected_yes")}for(l in o)d(".b-finder__row_id_"+o[l].data("id"),h).addClass("b-finder__row_expandable_yes");d(".b-finder__col_level_1",h).append(k);b.finder_holder|| v.call(i,f+1);return h}function v(c){var c=d('<div class="b-finder__col"></div>').addClass("b-finder__col_level_"+c).data("level",c),a=this.css("width").replace("px","")-0;this.append(c);a+=c.css("width").replace("px","")-0+(c.css("margin-right").replace("px","")-0)+(c.css("margin-left").replace("px","")-0);this.css("width",a+"px");return c}function z(c){var a=d('<div class="b-finder__group b-finder__group_id_'+c+'"></div>').data("id",c);c=="root"&&a.addClass("b-finder__group_expanded_yes");this.append(a); return a}function A(c,a,b){c=d('<div class="b-finder__row b-finder__row_id_'+c+'"></div>').text(b).attr("title",b.toLowerCase()).data({id:c,pid:a});this.append(c);return c}function q(c,a){var a=a||false,b=d(this),e=b.closest(".b-finder__group"),f=b.closest(".b-finder__col"),g=f.closest(".b-finder__scroll").closest(".b-finder__cols"),h=b.hasClass("b-finder__row_expandable_yes")?true:false,i=b.data("id"),k=e.data("id"),n=f.data("level");g.data("b_finder_prescroll");var o=g.hasClass("b-finder__cols_mode_search")? "search":"watch",m=n-1,l=d(".b-finder__row_id_"+k,g).get(0),j=g.data("b_finder_click");a&&(f.focus(),typeof j=="function"&&j.call(this,c,{id:i,pid:k,next:n+1,name:b.text(),expandable:h},g.data("b_finder_params")),d(".b-finder__group_expanded_yes",g).removeClass("b-finder__group_expanded_yes"),d(".b-finder__row_expanded_yes",g).removeClass("b-finder__row_expanded_yes"),h&&d(".b-finder__group_id_"+i,g).addClass("b-finder__group_expanded_yes"),g.addClass("b-finder__cols_active_yes"));b.hasClass("b-finder__row_selected_yes")|| b.addClass("b-finder__row_expanded_yes");e.addClass("b-finder__group_expanded_yes");o=="watch"&&a&&g.scrollLeft((f.css("width").replace("px","")-0+(f.css("margin-left").replace("px","")-0)+(f.css("margin-right").replace("px","")-0))*m);o=="watch"&&!a&&(f.scrollTop(b.offset().top-e.offset().top),n==1&&g.removeData("b_finder_prescroll"));n>1&&q.call(l,c,false)}function u(c){var a=d(this),b=a.closest(".b-finder__group"),e=a.closest(".b-finder__col"),f=e.closest(".b-finder__cols");f.data("b_finder_multiple"); f.data("b_finder_occupied");var g=f.data("b_finder_dblclick"),h=f.data("b_finder_params"),i=h.finder_multiple&&c.ctrlKey||h.finder_multiple&&c.metaKey?false:true,e=e.data("level")-0+1,b=b.data("id"),k=a.data("id");if(typeof g=="function"&&!a.hasClass("b-finder__row_selected_yes")||typeof g=="function"&&c.altKey)i&&f.data("b_finder_clear",true),c.altKey&&a.addClass("b-finder__row_cancel_yes"),a.removeClass("b-finder__row_expanded_yes").addClass("b-finder__row_loading_yes"),g.call(this,c,{hide:d.proxy(p, f.closest(".b-finder")),done:d.proxy(B,a),undone:d.proxy(C,a)},{id:k,pid:b,next:e,name:a.text(),action:c.altKey?"remove":"approve"},h)}function s(){var c=null;(c=d(".b-finder__row_selected_yes:first",this).get(0))||(c=d(".b-finder__group_id_root .b-finder__row:first",this).get(0));return c}function B(){var c=this.closest(".b-finder__cols");c.data("b_finder_clear")&&(d(".b-finder__row_selected_yes",c).removeClass("b-finder__row_selected_yes"),c.removeData("b_finder_clear"));this.hasClass("b-finder__row_cancel_yes")? this.removeClass("b-finder__row_selected_yes"):this.addClass("b-finder__row_selected_yes");this.removeClass("b-finder__row_loading_yes").removeClass("b-finder__row_cancel_yes");q.call(this,null,true)}function C(){this.removeClass("b-finder__row_loading_yes").addClass("b-finder__row_expanded_yes")}function t(){var c=d(this),a=d(".b-finder__cols_active_yes",c.closest(".b-finder__window")),b=null,e=null,f=d(".b-finder__found",a).empty(),g=0,h="",i="";a.removeClass("b-finder__cols_mode_watch").addClass("b-finder__cols_mode_search"); c.hasClass("b-finder__field")?(i=c.val(),g=i.length,e=g>0?d('.b-finder__row[title^="'+i.toLowerCase()+'"],.b-finder__row[title*=" '+i.toLowerCase()+'"]',a):d(".b-finder__row",a)):e=d(".b-finder__row_selected_yes",a);e&&e.length>0&&e.each(function(){b=d(this).clone().removeClass("b-finder__row_expandable_yes").removeClass("b-finder__row_expanded_yes").removeClass("b-finder__row_loading_yes").data("b_finder_link",this);g>0&&b.html(b.text().replace(RegExp("(^| )("+i+")","i"),'$1<span class="b-finder__highlight">$2</span>')); (h=d(".b-finder__group .b-finder__row_id_"+d(this).data("pid"),a).text())&&b.prepend(h+" > ");f.append(b)})}function r(c){var a=d(this).closest(".b-finder"),b=d(".b-finder__window",a),a=d(".b-finder__cols_active_yes",b),b=d(".b-finder__field",b),e=null;a.removeClass("b-finder__cols_mode_search").addClass("b-finder__cols_mode_watch");d(".b-finder__found",a).empty();b.val("").blur();e=s.call(a);q.call(e,c)}d.fn.finder=function(c,a,b){var b=b||{},a=a||{items_load:function(){return[]}},d=this;d.length== 0&&(d=y());d.hasClass("b-finder_hidden_yes")?w.call(d,c,a,b):p.call(d);return this}})(jQuery);