/**
 * Finder
 *
 * @version 3.0
 * @author  Shushik <silkleopard@yandex.ru>
 */
(function(d){function w(b,a,c){var e=d(window),f=d(".b-finder__cols_id_"+b,this),g=null;e.bind("keydown.b_finder_hide",function(a){var b=d(".b-finder"),c=d(".b-finder__cols_active_yes"),e=c.hasClass("b-finder__cols_mode_search")?"search":"watch",f=a.keyCode;f==27&&e=="search"?(a.stopPropagation(),r.call(c.get(0),a)):f==27&&p.call(b)});d(".b-finder__hat",this).html(c.finder_lang&&c.finder_lang.hat?c.finder_lang.hat:"&nbsp;");d(".b-finder__hint",this).html(c.finder_lang&&c.finder_lang.hint?c.finder_lang.hint: "&nbsp;");d(".b-finder__field",this).attr("placeholder",c.finder_lang&&c.finder_lang.search?c.finder_lang.search:"");d(".b-finder__filter",this).attr("title",c.finder_lang&&c.finder_lang.selected?c.finder_lang.selected:"");f.length==0&&(f=x.call(this,b,a,c));f.data("b_finder_prescroll",true);g=s.call(f);d(g).mousedown();this.removeClass("b-finder_hidden_yes")}function p(){d(window).unbind("keydown.b_finder_hide");this.addClass("b-finder_hidden_yes");d(".b-finder__cols_active_yes",this).removeClass("b-finder__cols_active_yes")} function y(){var b=d('<table class="b-finder b-finder_hidden_yes"><tr><td class="b-finder__valign"><div class="b-finder__window"><div class="b-finder__search"><div class="b-finder__filter"></div><div class="b-finder__clear">\u00d7</div><input class="b-finder__field" type="search"></div><div class="b-finder__hide">\u00d7</div><div class="b-finder__hat"></div><div class="b-finder__hint"></div></div></td></tr></table>'),a=d(".b-finder__window",b),c=d(".b-finder__hide",a);d("body").append(b);b.click(function(){p.call(d(this))}); c.click(function(){p.call(d(this).closest(".b-finder"))});a.click(function(a){a.stopPropagation()});a.delegate(".b-finder__field","keydown",function(a){var b=d(this),c=b.data("b_finder_search"),a=a.keyCode;c&&clearTimeout(c);b.hasClass("b-finder__field")&&a!=37&&a!=38&&a!=39&&a!=40&&a!=27&&b.data("b_finder_search",setTimeout(d.proxy(t,this),300))});a.delegate(".b-finder__filter","click",function(a){var b=d(this);b.hasClass("b-finder__filter_active_yes")?(b.removeClass("b-finder__filter_active_yes"), r.call(this,a)):(b.addClass("b-finder__filter_active_yes"),t.call(this))});a.delegate(".b-finder__clear","click",r);a.delegate(".b-finder__col","mouseover",function(){d(this).focus()});a.delegate(".b-finder__row","mousedown",function(a){var b=d(this),c=b.closest(".b-finder__cols"),h=this,i=c.data("clicked"),k=b.closest(".b-finder__found").length>0?b.data("b_finder_link"):null;i?i&&(i&&(clearInterval(i),c.removeData("clicked")),k&&u.call(k,a),u.call(h,a)):c.data("clicked",setTimeout(function(){c.removeData("clicked"); k&&q.call(k,a,true);q.call(h,a,true)},200))});return b}function x(b,a,c){var e=c.finder_cols&&typeof c.finder_cols=="number"&&c.finder_cols<5&&c.finder_cols>0?c.finder_cols:4,f=0,g=d(".b-finder__hat",this),h=d('<div class="b-finder__cols"></div>'),i=d('<div class="b-finder__scroll"></div>'),k=d('<div class="b-finder__found"></div>'),n={},o={},m,l,j;g.after(h.addClass("b-finder__cols_id_"+b).addClass("b-finder__cols_x_"+e).addClass("b-finder__cols_mode_watch").data("b_finder_params",c));for(l in a)h.data("b_finder_"+ l,a[l]);h.append(i);a=a.load(c);for(l=0;l<a.total;l++){j=a.items[l];m=j.level;g=j.name;e="root";b=j.id;if(j.parentId)e=j.parentId;else if(j.parent_id)e=j.parent_id;else if(j.pid)e=j.pid;n[m]||(n[m]=v.call(i,m),f<m&&(f=m));o[e]||(o[e]=z.call(n[m],e));e=A.call(o[e],b,e,g);c.finder_selected&&c.finder_selected.indexOf(b)>-1&&e.addClass("b-finder__row_selected_yes")}for(l in o)d(".b-finder__row_id_"+o[l].data("id"),h).addClass("b-finder__row_expandable_yes");d(".b-finder__col_level_1",h).append(k);c.finder_holder|| v.call(i,f+1);return h}function v(b){var b=d('<div class="b-finder__col"></div>').addClass("b-finder__col_level_"+b).data("level",b),a=this.css("width").replace("px","")-0;this.append(b);a+=b.css("width").replace("px","")-0+(b.css("margin-right").replace("px","")-0)+(b.css("margin-left").replace("px","")-0);this.css("width",a+"px");return b}function z(b){var a=d('<div class="b-finder__group b-finder__group_id_'+b+'"></div>').data("id",b);b=="root"&&a.addClass("b-finder__group_expanded_yes");this.append(a); return a}function A(b,a,c){b=d('<div class="b-finder__row b-finder__row_id_'+b+'"></div>').text(c).attr("title",c.toLowerCase()).data({id:b,pid:a});this.append(b);return b}function q(b,a){var a=a||false,c=d(this),e=c.closest(".b-finder__group"),f=c.closest(".b-finder__col"),g=f.closest(".b-finder__scroll").closest(".b-finder__cols"),h=c.hasClass("b-finder__row_expandable_yes")?true:false,i=c.data("id"),k=e.data("id"),n=f.data("level");g.data("b_finder_prescroll");var o=g.hasClass("b-finder__cols_mode_search")? "search":"watch",m=n-1,l=d(".b-finder__row_id_"+k,g).get(0),j=g.data("b_finder_click");a&&(f.focus(),typeof j=="function"&&j.call(this,b,{id:i,pid:k,next:n+1,name:c.text(),expandable:h},g.data("b_finder_params")),d(".b-finder__group_expanded_yes",g).removeClass("b-finder__group_expanded_yes"),d(".b-finder__row_expanded_yes",g).removeClass("b-finder__row_expanded_yes"),h&&d(".b-finder__group_id_"+i,g).addClass("b-finder__group_expanded_yes"),g.addClass("b-finder__cols_active_yes"));c.hasClass("b-finder__row_selected_yes")|| c.addClass("b-finder__row_expanded_yes");e.addClass("b-finder__group_expanded_yes");o=="watch"&&a&&g.scrollLeft((f.css("width").replace("px","")-0+(f.css("margin-left").replace("px","")-0)+(f.css("margin-right").replace("px","")-0))*m);o=="watch"&&!a&&(f.scrollTop(c.offset().top-e.offset().top),n==1&&g.removeData("b_finder_prescroll"));n>1&&q.call(l,b,false)}function u(b){var a=d(this),c=a.closest(".b-finder__group"),e=a.closest(".b-finder__col"),f=e.closest(".b-finder__cols");f.data("b_finder_multiple"); f.data("b_finder_occupied");var g=f.data("b_finder_dblclick"),h=f.data("b_finder_params"),i=h.finder_multiple&&b.ctrlKey||h.finder_multiple&&b.metaKey?false:true,e=e.data("level")-0+1,c=c.data("id"),k=a.data("id");if(typeof g=="function"&&!a.hasClass("b-finder__row_selected_yes")||typeof g=="function"&&b.altKey)i&&f.data("b_finder_clear",true),b.altKey&&a.addClass("b-finder__row_cancel_yes"),a.removeClass("b-finder__row_expanded_yes").addClass("b-finder__row_loading_yes"),g.call(this,b,{hide:d.proxy(p, f.closest(".b-finder")),done:d.proxy(B,a),undone:d.proxy(C,a)},{id:k,pid:c,next:e,name:a.text(),action:b.altKey?"remove":"approve"},h)}function s(){var b=null;(b=d(".b-finder__row_selected_yes:first",this).get(0))||(b=d(".b-finder__group_id_root .b-finder__row:first",this).get(0));return b}function B(){var b=this.closest(".b-finder__cols");b.data("b_finder_clear")&&(d(".b-finder__row_selected_yes",b).removeClass("b-finder__row_selected_yes"),b.removeData("b_finder_clear"));this.hasClass("b-finder__row_cancel_yes")? this.removeClass("b-finder__row_selected_yes"):this.addClass("b-finder__row_selected_yes");this.removeClass("b-finder__row_loading_yes").removeClass("b-finder__row_cancel_yes");q.call(this,null,true)}function C(){this.removeClass("b-finder__row_loading_yes").addClass("b-finder__row_expanded_yes")}function t(){var b=d(this),a=d(".b-finder__cols_active_yes",b.closest(".b-finder__window")),c=null,e=null,f=d(".b-finder__found",a).empty(),g=0,h="",i="";a.removeClass("b-finder__cols_mode_watch").addClass("b-finder__cols_mode_search"); b.hasClass("b-finder__field")?(i=b.val(),g=i.length,e=g>0?d('.b-finder__row[title^="'+i.toLowerCase()+'"],.b-finder__row[title*=" '+i.toLowerCase()+'"]',a):d(".b-finder__row",a)):e=d(".b-finder__row_selected_yes",a);e&&e.length>0&&e.each(function(){c=d(this).clone().removeClass("b-finder__row_expandable_yes").removeClass("b-finder__row_expanded_yes").removeClass("b-finder__row_loading_yes").data("b_finder_link",this);g>0&&c.html(c.text().replace(RegExp("(^| )("+i+")","i"),'$1<span class="b-finder__highlight">$2</span>')); (h=d(".b-finder__group .b-finder__row_id_"+d(this).data("pid"),a).text())&&c.prepend(h+" > ");f.append(c)})}function r(b){var a=d(this).closest(".b-finder"),a=d(".b-finder__window",a),c=d(".b-finder__cols_active_yes",a),e=null;c.removeClass("b-finder__cols_mode_search").addClass("b-finder__cols_mode_watch");d(".b-finder__found",c).empty();d(".b-finder__field",a).val("").blur();d(".b-finder__filter",a).removeClass("b-finder__filter_active_yes");e=s.call(c);q.call(e,b)}d.fn.finder=function(b,a,c){var c= c||{},a=a||{items_load:function(){return[]}},d=this;d.length==0&&(d=y());d.hasClass("b-finder_hidden_yes")?w.call(d,b,a,c):p.call(d);return this}})(jQuery);