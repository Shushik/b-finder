/**
 * b-finder script
 *
 * @version 3.0
 * @author  Shushik <silkleopard@yandex.ru>
 * @page    http://github.com/Shushik/b-finder
 *
 * @requires jQuery 1.4+
 */
(function(c){function w(d,a,b){var e=c(window),f=c(".b-finder__cols_id_"+d,this),h=null;e.bind("keydown.b_finder_hide",function(a){var e=c(".b-finder"),b=c(".b-finder__cols_active_yes"),d=b.hasClass("b-finder__cols_mode_search")?"search":"watch",f=a.keyCode,h={38:"top",39:"right",40:"bottom",37:"left"};h[f]?(a.preventDefault(),x.call(b,a,h[f])):13==f?t.call(r.call(b,"last"),a):27==f&&"search"==d?(a.stopPropagation(),s.call(b.get(0),a)):27==f&&p.call(e)});c(".b-finder__hat",this).html(b.finder_lang&& b.finder_lang.hat?b.finder_lang.hat:"&nbsp;");c(".b-finder__hint",this).html(b.finder_lang&&b.finder_lang.hint?b.finder_lang.hint:"&nbsp;");c(".b-finder__field",this).attr("placeholder",b.finder_lang&&b.finder_lang.search?b.finder_lang.search:"");c(".b-finder__filter",this).attr("title",b.finder_lang&&b.finder_lang.selected?b.finder_lang.selected:"");0==f.length&&(f=y.call(this,d,a,b));f.data("b_finder_prescroll",!0);h=r.call(f);q.call(h,null,!0);this.removeClass("b-finder_hidden_yes")}function p(){c(window).unbind("keydown.b_finder_hide"); this.addClass("b-finder_hidden_yes");c(".b-finder__cols_active_yes",this).removeClass("b-finder__cols_active_yes")}function z(){var d=c('<table class="b-finder b-finder_hidden_yes"><tr><td class="b-finder__valign"><div class="b-finder__window"><div class="b-finder__search"><div class="b-finder__filter"></div><div class="b-finder__clear">\u00d7</div><input class="b-finder__field" autocomplete="off" ></div><div class="b-finder__hide">\u00d7</div><div class="b-finder__hat"></div><div class="b-finder__hint"></div></div></td></tr></table>'), a=c(".b-finder__window",d),b=c(".b-finder__hide",a);c("body").append(d);d.click(function(){p.call(c(this))});b.click(function(){p.call(c(this).closest(".b-finder"))});a.click(function(a){a.stopPropagation()});a.delegate(".b-finder__field","keydown",function(a){var b=c(this),d=b.data("b_finder_search"),a=a.keyCode;d&&clearTimeout(d);b.hasClass("b-finder__field")&&(40==a?b.blur():27!=a&&b.data("b_finder_search",setTimeout(c.proxy(u,this),300)))});a.delegate(".b-finder__filter","click",function(a){var b= c(this);b.hasClass("b-finder__filter_active_yes")?(b.removeClass("b-finder__filter_active_yes"),s.call(this,a)):(b.addClass("b-finder__filter_active_yes"),u.call(this))});a.delegate(".b-finder__clear","click",s);a.delegate(".b-finder__row","click",function(a){q.call(this,a,!0)});a.delegate(".b-finder__row","dblclick",function(a){t.call(this,a)});return d}function y(d,a,b){var e=b.finder_cols&&"number"==typeof b.finder_cols&&5>b.finder_cols&&0<b.finder_cols?b.finder_cols:4,f=0,h=c(".b-finder__hat", this),g=c('<div class="b-finder__cols"></div>'),k=c('<div class="b-finder__scroll"></div>'),l=c('<div class="b-finder__found"></div>'),o={},m={},j,n,i;h.after(g.addClass("b-finder__cols_id_"+d).addClass("b-finder__cols_x_"+e).addClass("b-finder__cols_mode_watch").data("b_finder_params",b));for(n in a)g.data("b_finder_"+n,a[n]);g.append(k);a=a.load(b);for(n=0;n<a.total;n++){i=a.items[n];j=i.level;h=i.name;e="root";d=i.id;if(i.parentId)e=i.parentId;else if(i.parent_id)e=i.parent_id;else if(i.pid)e= i.pid;o[j]||(o[j]=v.call(k,j),f<j&&(f=j));m[e]||(m[e]=A.call(o[j],e));e=B.call(m[e],d,e,h);b.finder_selected&&-1<c.inArray(b.finder_selected,d)&&e.addClass("b-finder__row_selected_yes")}for(n in m)c(".b-finder__row_id_"+m[n].data("id"),g).addClass("b-finder__row_expandable_yes");c(".b-finder__col_level_1",g).append(l);b.finder_holder||v.call(k,f+1);return g}function v(d){var d=c('<div class="b-finder__col"></div>').addClass("b-finder__col_level_"+d).data("level",d),a=this.css("width").replace("px", "")-0;this.append(d);a+=d.css("width").replace("px","")-0+(d.css("margin-right").replace("px","")-0)+(d.css("margin-left").replace("px","")-0);this.css("width",a+"px");return d}function A(d){var a=c('<div class="b-finder__group b-finder__group_id_'+d+'"></div>').data("id",d);"root"==d&&a.addClass("b-finder__group_expanded_yes");this.append(a);return a}function B(d,a,b){d=c('<div class="b-finder__row b-finder__row_id_'+d+'"></div>').text(b).attr("title",b.toLowerCase()).data({id:d,pid:a});this.append(d); return d}function q(d,a,b){var a=a||!1,b=b||!1,e=c(this),f=e.closest(".b-finder__group,.b-finder__found"),h=e.closest(".b-finder__col"),g=h.closest(".b-finder__scroll").closest(".b-finder__cols"),k=e.hasClass("b-finder__row_expandable_yes")?!0:!1,l=e.data("id"),o=e.data("pid"),m=h.data("level");g.data("b_finder_prescroll");var j=g.hasClass("b-finder__cols_mode_search")?"search":"watch",n=m-2,i=e.data("b_finder_row"),r="search"==j?null:c(".b-finder__row_id_"+o,g).get(0),p=g.data("b_finder_click"); a&&(h.focus(),"function"==typeof p&&!i&&p.call(this,d,{id:l,pid:o,next:m+1,name:e.text(),expandable:k},g.data("b_finder_params")),c(".b-finder__group_expanded_yes",g).removeClass("b-finder__group_expanded_yes"),c(".b-finder__row_expanded_yes",g).removeClass("b-finder__row_expanded_yes"),k&&c(".b-finder__group_id_"+l,g).addClass("b-finder__group_expanded_yes"),g.addClass("b-finder__cols_active_yes"),"search"==j&&i&&q.call(i,d,!0));e.addClass("b-finder__row_expanded_yes");i&&c(i).addClass("b-finder__row_expanded_yes"); "watch"==j&&f.addClass("b-finder__group_expanded_yes");"watch"==j&&a&&!b&&g.data("b_finder_scroll",setTimeout(function(){g.scrollLeft((h.css("width").replace("px","")-0+(h.css("margin-left").replace("px","")-0)+(h.css("margin-right").replace("px","")-0))*n)},200));if("watch"==j&&!a||d&&38==d.keyCode||d&&40==d.keyCode)h.scrollTop(e.offset().top-f.offset().top),1==m&&g.removeData("b_finder_prescroll");"watch"==j&&1<m&&q.call(r,d,!1)}function t(d){var a=c(this),b=a.closest(".b-finder__group"),e=a.closest(".b-finder__col"), f=e.closest(".b-finder__cols");f.data("b_finder_multiple");var h=f.data("b_finder_dblclick"),g=f.data("b_finder_scroll"),k=f.data("b_finder_params"),l=k.finder_multiple&&d.ctrlKey||k.finder_multiple&&d.metaKey?!1:!0,e=e.data("level")-0+1,o=a.hasClass("b-finder__row_selected_yes")?"cancel":"approve",b=b.data("id"),m=a.data("id");a.data("b_finder_row");g&&clearTimeout(g);"function"==typeof h&&(l&&"approve"==o&&f.data("b_finder_clear",!0),"cancel"==o&&a.addClass("b-finder__row_cancel_yes"),a.addClass("b-finder__row_loading_yes"), h.call(this,d,{hide:c.proxy(p,f.closest(".b-finder")),done:c.proxy(C,a),undone:c.proxy(D,a)},{id:m,pid:b,next:e,name:a.text(),action:o,expandable:a.hasClass("b-finder__row_expandable_yes")?!0:!1},k))}function x(d,a){var b=this.hasClass("b-finder__cols_mode_search")?"search":"watch",e=c(r.call("search"==b?c(".b-finder__found",this):this,"search"==b?"first":"last")),f=null;if("top"==a)f=e.prev();else if("bottom"==a)f=e.next();else if("watch"==b&&e.hasClass("b-finder__row_expandable_yes")&&"right"== a||"watch"==b&&"left"==a&&"root"!=e.data("pid"))"right"==a?f=c(r.call(c(".b-finder__group_expanded_yes:last",this),"first")):(e.removeClass("b-finder__row_expanded_yes"),f=c(".b-finder__row_id_"+e.data("pid"),this));this.data("b_finder_prescroll",!0);f&&0<f.length&&q.call(f.get(0),d,!0)}function r(){var d=null;(d=c(".b-finder__row_expanded_yes:last",this).get(0))||(d=this.hasClass("b-finder__group")||this.hasClass("b-finder__found")?c(".b-finder__row",this).get(0):c(".b-finder__group_id_root .b-finder__row:first", this).get(0));return d}function C(){var d=this.closest(".b-finder__cols"),a=d.data("b_finder_clear"),b=this.data("b_finder_row");a&&(c(".b-finder__row_selected_yes",d).removeClass("b-finder__row_selected_yes"),d.removeData("b_finder_clear"));this.hasClass("b-finder__row_cancel_yes")?(this.removeClass("b-finder__row_selected_yes"),b&&c(b).removeClass("b-finder__row_selected_yes")):(this.addClass("b-finder__row_selected_yes"),b&&c(b).addClass("b-finder__row_selected_yes"));this.removeClass("b-finder__row_loading_yes").removeClass("b-finder__row_cancel_yes"); q.call(this,null,!0)}function D(){this.removeClass("b-finder__row_loading_yes");q.call(this,null,!0)}function u(){var d=c(this),a=c(".b-finder__cols_active_yes",d.closest(".b-finder__window")),b=null,e=null,f=c(".b-finder__found",a).empty(),h=0,g=0,k="",l="";a.removeClass("b-finder__cols_mode_watch").addClass("b-finder__cols_mode_search").scrollLeft(0);d.hasClass("b-finder__field")?(l=d.val(),g=l.length,e=0<g?c('.b-finder__row[title^="'+l.toLowerCase()+'"],.b-finder__row[title*=" '+l.toLowerCase()+ '"]',a):c(".b-finder__row",a)):e=c(".b-finder__row_selected_yes",a);e&&0<e.length&&e.each(function(){b=c(this).clone().removeClass("b-finder__row_expandable_yes").removeClass("b-finder__row_expanded_yes").removeClass("b-finder__row_loading_yes").data("b_finder_row",this);0==h&&b.addClass("b-finder__row_expanded_yes");0<g&&b.html(b.text().replace(RegExp("(^| )("+l+")","i"),'$1<span class="b-finder__highlight">$2</span>'));(k=c(".b-finder__group .b-finder__row_id_"+c(this).data("pid"),a).text())&&b.prepend(k+ " > ");f.append(b);h++})}function s(d){var a=c(this).closest(".b-finder"),a=c(".b-finder__window",a),b=c(".b-finder__cols_active_yes",a),e=null;b.removeClass("b-finder__cols_mode_search").addClass("b-finder__cols_mode_watch");c(".b-finder__found",b).empty();c(".b-finder__field",a).val("").blur();c(".b-finder__filter",a).removeClass("b-finder__filter_active_yes");e=r.call(b,"last");q.call(e,d)}c.fn.finder=function(c,a,b){var b=b||{},a=a||{items_load:function(){return[]}},e=this;0==e.length&&(e=z()); e.hasClass("b-finder_hidden_yes")?w.call(e,c,a,b):p.call(e);return this}})(jQuery);