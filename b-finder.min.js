/**
 * b-finder script
 *
 * @version 3.0
 * @author  Shushik <silkleopard@yandex.ru>
 * @page    http://github.com/Shushik/b-finder
 *
 * @requires jQuery 1.6+
 */
;(function(c){function y(){var d=c(window),a=null,b=this.data("params"),e=this.data("handlers");b.finder_static&&this.addClass("b-finder_static_yes");a=c(".b-finder__cols_id_"+b.finder_id,this);d.bind("keydown.finder_keydown",function(a){var d=c(".b-finder"),b=c(".b-finder__cols_active_yes"),e=b.hasClass("b-finder__cols_mode_search")?"search":"watch",g=a.keyCode,j={38:"top",39:"right",40:"bottom",37:"left"};j[g]?(a.preventDefault(),z.call(b,a,j[g])):13==g?t.call(o.call(b,"search"==e?"first":"last"), a):27==g&&"search"==e?(a.stopPropagation(),s.call(b.get(0),a)):27==g&&q.call(d)});c(".b-finder__hat",this).html(b.finder_lang&&b.finder_lang.hat?b.finder_lang.hat:"&nbsp;");c(".b-finder__hint",this).html(b.finder_lang&&b.finder_lang.hint?b.finder_lang.hint:"&nbsp;");c(".b-finder__field",this).attr("placeholder",b.finder_lang&&b.finder_lang.search?b.finder_lang.search:"");c(".b-finder__filter",this).attr("title",b.finder_lang&&b.finder_lang.selected?b.finder_lang.selected:"");0!=a.length?u.call(a): b.finder_async?e.load.call(this,b,{done:c.proxy(v,this)}):a=v.call(this,e.load.call(this,b))}function q(){c(window).unbind("keydown.finder_keydown");this.addClass("b-finder_hidden_yes").removeClass("b-finder_static_yes");c(".b-finder__cols_active_yes",this).removeClass("b-finder__cols_active_yes")}function A(){var d=c(this),a=c('<table class="b-finder b-finder_hidden_yes"><tr><td class="b-finder__valign"><div class="b-finder__window"><div class="b-finder__search"><div class="b-finder__filter"></div><div class="b-finder__clear">\u00d7</div><input class="b-finder__field" autocomplete="off" ></div><div class="b-finder__hide">\u00d7</div><div class="b-finder__hat"></div><div class="b-finder__hint"></div></div></td></tr></table>'), b=c(".b-finder__window",a),e=c(".b-finder__hide",b);d.hasClass("b-finder-placeholder")?d.replaceWith(a):c("body").append(a);a.click(function(){q.call(c(this))});e.click(function(){q.call(c(this).closest(".b-finder"))});b.click(function(a){a.stopPropagation()});b.delegate(".b-finder__field","keydown",function(a){var b=c(this),d=b.data("search"),a=a.keyCode;d&&clearTimeout(d);b.hasClass("b-finder__field")&&(40==a?b.blur():27!=a&&b.data("b_finder_search",setTimeout(c.proxy(w,this),300)))});b.delegate(".b-finder__filter", "click",function(a){var b=c(this);b.hasClass("b-finder__filter_active_yes")?(b.removeClass("b-finder__filter_active_yes"),s.call(this,a)):(b.addClass("b-finder__filter_active_yes"),w.call(this))});b.delegate(".b-finder__clear","click",s);b.delegate(".b-finder__row","click",function(a){k.call(this,a,!0)});b.delegate(".b-finder__row","dblclick",function(a){t.call(this,a)});return a}function u(){var c=this.closest(".b-finder"),a=null;this.data("prescroll",!0);a=o.call(this);k.call(a,null,!0);c.removeClass("b-finder_hidden_yes")} function v(d){var a=4,b=0,e=0,e=c(".b-finder__hat",this),f=c('<div class="b-finder__cols"></div>'),i=c('<div class="b-finder__scroll"></div>'),h=c('<div class="b-finder__found"></div>'),r={},g={},j=this.data("params");this.data("handlers");var l,k,n,p,m;if(j.finder_cols&&5>j.finder_cols&&0<j.finder_cols)a=j.finder_cols;e.after(f.addClass("b-finder__cols_id_"+j.finder_id).addClass("b-finder__cols_x_"+a).addClass("b-finder__cols_mode_watch"));f.append(i);e=d.length;for(p=0;p<e;p++){m=d[p];n=m.level; k=m.name;l="root";a=m.id;if(m.parentId)l=m.parentId;else if(m.parent_id)l=m.parent_id;else if(m.pid)l=m.pid;r[n]||(r[n]=x.call(i,n),b<n&&(b=n));g[l]||(g[l]=B.call(r[n],l));l=C.call(g[l],a,l,k);j.finder_selected&&-1<c.inArray(a,j.finder_selected)&&l.addClass("b-finder__row_expanded_yes").addClass("b-finder__row_selected_yes")}for(p in g)c(".b-finder__row_id_"+g[p].data("id"),f).addClass("b-finder__row_expandable_yes");c(".b-finder__col_level_1",f).append(h);j.finder_holder||x.call(i,b+1);u.call(f)} function x(d){var d=c('<div class="b-finder__col"></div>').addClass("b-finder__col_level_"+d).data("level",d),a=this.css("width").replace("px","")-0;this.append(d);a+=d.css("width").replace("px","")-0+(d.css("margin-right").replace("px","")-0)+(d.css("margin-left").replace("px","")-0);this.css("width",a+"px");return d}function B(d){var a=c('<div class="b-finder__group b-finder__group_id_'+d+'"></div>').data("id",d);"root"==d&&a.addClass("b-finder__group_expanded_yes");this.append(a);return a}function C(d, a,b){d=c('<div class="b-finder__row b-finder__row_id_'+d+'"></div>').text(b).attr("title",b.toLowerCase()).data({id:d,pid:a});this.append(d);return d}function k(d,a,b){var a=a||!1,b=b||!1,e=c(this),f=e.closest(".b-finder__group,.b-finder__found"),i=e.closest(".b-finder__col"),h=i.closest(".b-finder__scroll").closest(".b-finder__cols"),r=h.closest(".b-finder"),g=e.hasClass("b-finder__row_expandable_yes")?!0:!1,j=e.data("id"),l=e.data("pid"),o=i.data("level");h.data("prescroll");var n=h.hasClass("b-finder__cols_mode_search")? "search":"watch",p=o-2,m=e.data("row"),q="search"==n?null:c(".b-finder__row_id_"+l,h).get(0),s=r.data("handlers");a&&(s.click&&!m&&s.click.call(this,d,{id:j,pid:l,next:o+1,name:e.text(),expandable:g},r.data("params")),c(".b-finder__group_expanded_yes",h).removeClass("b-finder__group_expanded_yes"),c(".b-finder__row_expanded_yes",h).removeClass("b-finder__row_expanded_yes"),g&&c(".b-finder__group_id_"+j,h).addClass("b-finder__group_expanded_yes"),h.addClass("b-finder__cols_active_yes"),"search"==n&& m&&k.call(m,d,!0));e.addClass("b-finder__row_expanded_yes");m&&c(m).addClass("b-finder__row_expanded_yes");"watch"==n&&f.addClass("b-finder__group_expanded_yes");"watch"==n&&a&&!b&&h.data("b_finder_scroll",setTimeout(function(){h.scrollLeft((i.css("width").replace("px","")-0+(i.css("margin-left").replace("px","")-0)+(i.css("margin-right").replace("px","")-0))*p)},200));if("watch"==n&&!a||d&&38==d.keyCode||d&&40==d.keyCode)i.scrollTop(e.offset().top-f.offset().top),1==o&&h.removeData("prescroll"); "watch"==n&&1<o&&k.call(q,d,!1)}function t(d){var a=c(this),b=a.closest(".b-finder__group"),e=a.closest(".b-finder__col"),f=e.closest(".b-finder__cols"),i=f.closest(".b-finder"),h=i.data("params"),i=i.data("handlers"),k=h.finder_multiple&&d.ctrlKey||h.finder_multiple&&d.metaKey?!1:!0,g=f.data("scroll"),e=e.data("level")-0+1,j=a.hasClass("b-finder__row_selected_yes")?"cancel":"approve",b=b.data("id"),l=a.data("id");a.data("row");g&&clearTimeout(g);i.dblclick&&(k&&"approve"==j&&f.data("clear",!0),"cancel"== j&&a.addClass("b-finder__row_cancel_yes"),a.addClass("b-finder__row_loading_yes"),i.dblclick.call(this,d,{hide:c.proxy(q,f.closest(".b-finder")),done:c.proxy(D,a.get(0)),undone:c.proxy(E,a.get(0))},{id:l,pid:b,next:e,name:a.text(),action:j,expandable:a.hasClass("b-finder__row_expandable_yes")?!0:!1},h))}function z(d,a){var b=this.hasClass("b-finder__cols_mode_search")?"search":"watch",e=c(o.call("search"==b?c(".b-finder__found",this):this,"last")),f=null;if("top"==a)f=e.prev();else if("bottom"==a)f= e.next();else if("watch"==b&&e.hasClass("b-finder__row_expandable_yes")&&"right"==a||"watch"==b&&"left"==a&&"root"!=e.data("pid"))"right"==a?f=c(o.call(c(".b-finder__group_expanded_yes:last",this),"first")):(e.removeClass("b-finder__row_expanded_yes"),f=c(".b-finder__row_id_"+e.data("pid"),this));this.data("prescroll",!0);f&&0<f.length&&k.call(f.get(0),d,!0)}function o(d){var d=d||"first",a=null;(a=c(".b-finder__row_expanded_yes:"+d,this).get(0))||(a=this.hasClass("b-finder__group")||this.hasClass("b-finder__found")? c(".b-finder__row",this).get(0):c(".b-finder__group_id_root .b-finder__row:"+d,this).get(0));return a}function D(){var d=c(this),a=d.closest(".b-finder__cols"),b=a.data("clear"),e=d.data("row");b&&(c(".b-finder__row_selected_yes",a).removeClass("b-finder__row_selected_yes"),a.removeData("clear"));d.hasClass("b-finder__row_cancel_yes")?(d.removeClass("b-finder__row_selected_yes"),e&&c(e).removeClass("b-finder__row_selected_yes")):(d.addClass("b-finder__row_selected_yes"),e&&c(e).addClass("b-finder__row_selected_yes")); d.removeClass("b-finder__row_loading_yes").removeClass("b-finder__row_cancel_yes");k.call(this,null,!0)}function E(){this.removeClass("b-finder__row_loading_yes");k.call(this,null,!0)}function w(){var d=c(this),a=c(".b-finder__cols_active_yes",d.closest(".b-finder__window")),b=null,e=null,f=c(".b-finder__found",a).empty(),i=0,h=0,k="",g="";a.removeClass("b-finder__cols_mode_watch").addClass("b-finder__cols_mode_search").scrollLeft(0);d.hasClass("b-finder__field")?(g=d.val(),h=g.length,e=0<h?c('.b-finder__row[title^="'+ g.toLowerCase()+'"],.b-finder__row[title*=" '+g.toLowerCase()+'"]',a):c(".b-finder__row",a)):e=c(".b-finder__row_selected_yes",a);e&&0<e.length&&e.each(function(){b=c(this).clone().removeClass("b-finder__row_expandable_yes").removeClass("b-finder__row_expanded_yes").removeClass("b-finder__row_loading_yes").data("row",this);0==i&&b.addClass("b-finder__row_expanded_yes");0<h&&b.html(b.text().replace(RegExp("(^| )("+g+")","i"),'$1<span class="b-finder__highlight">$2</span>'));(k=c(".b-finder__group .b-finder__row_id_"+ c(this).data("pid"),a).text())&&b.prepend(k+" > ");f.append(b);i++})}function s(d){var a=c(this).closest(".b-finder"),a=c(".b-finder__window",a),b=c(".b-finder__cols_active_yes",a),e=null;b.removeClass("b-finder__cols_mode_search").addClass("b-finder__cols_mode_watch");c(".b-finder__found",b).empty();c(".b-finder__field",a).val("").blur();c(".b-finder__filter",a).removeClass("b-finder__filter_active_yes");e=o.call(b,"last");k.call(e,d)}c.fn.finder=function(c,a,b){var b=b||{},a=a||{items_load:function(){return[]}}, e=this;b.finder_id=c;if(0==e.length||e.hasClass("b-finder-placeholder"))e=A.call(e);e.hasClass("b-finder_hidden_yes")?(e.data("params",b),e.data("handlers",a),y.call(e)):q.call(e);return this}})(jQuery);