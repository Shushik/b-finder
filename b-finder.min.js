/**
 * b-finder script
 *
 * @version 3.0
 * @author  Shushik <silkleopard@yandex.ru>
 * @page    http://github.com/Shushik/b-finder
 *
 * @requires jQuery 1.4+
 */
(function(c){function v(b,a,d){var e=c(window),g=c(".b-finder__cols_id_"+b,this),h=null;e.bind("keydown.b_finder_hide",function(a){var e=c(".b-finder"),b=c(".b-finder__cols_active_yes"),d=b.hasClass("b-finder__cols_mode_search")?"search":"watch",g=a.keyCode;27==g&&"search"==d?(a.stopPropagation(),q.call(b.get(0),a)):27==g&&p.call(e)});c(".b-finder__hat",this).html(d.finder_lang&&d.finder_lang.hat?d.finder_lang.hat:"&nbsp;");c(".b-finder__hint",this).html(d.finder_lang&&d.finder_lang.hint?d.finder_lang.hint: "&nbsp;");c(".b-finder__field",this).attr("placeholder",d.finder_lang&&d.finder_lang.search?d.finder_lang.search:"");c(".b-finder__filter",this).attr("title",d.finder_lang&&d.finder_lang.selected?d.finder_lang.selected:"");0==g.length&&(g=w.call(this,b,a,d));g.data("b_finder_prescroll",!0);h=r.call(g);n.call(h,null,!0);this.removeClass("b-finder_hidden_yes")}function p(){c(window).unbind("keydown.b_finder_hide");this.addClass("b-finder_hidden_yes");c(".b-finder__cols_active_yes",this).removeClass("b-finder__cols_active_yes")} function x(){var b=c('<table class="b-finder b-finder_hidden_yes"><tr><td class="b-finder__valign"><div class="b-finder__window"><div class="b-finder__search"><div class="b-finder__filter"></div><div class="b-finder__clear">\u00d7</div><input class="b-finder__field" autocomplete="off" ></div><div class="b-finder__hide">\u00d7</div><div class="b-finder__hat"></div><div class="b-finder__hint"></div></div></td></tr></table>'),a=c(".b-finder__window",b),d=c(".b-finder__hide",a);c("body").append(b);b.click(function(){p.call(c(this))}); d.click(function(){p.call(c(this).closest(".b-finder"))});a.click(function(a){a.stopPropagation()});a.delegate(".b-finder__field","keydown",function(a){var b=c(this),d=b.data("b_finder_search"),a=a.keyCode;d&&clearTimeout(d);b.hasClass("b-finder__field")&&37!=a&&38!=a&&39!=a&&40!=a&&27!=a&&b.data("b_finder_search",setTimeout(c.proxy(s,this),300))});a.delegate(".b-finder__filter","click",function(a){var b=c(this);b.hasClass("b-finder__filter_active_yes")?(b.removeClass("b-finder__filter_active_yes"), q.call(this,a)):(b.addClass("b-finder__filter_active_yes"),s.call(this))});a.delegate(".b-finder__clear","click",q);a.delegate(".b-finder__col","mouseover",function(){c(this).focus()});a.delegate(".b-finder__row","click",function(a){var b=c(this),d=b.data("b_finder_row");b.hasClass("b-finder__row_expanded_yes")||(d&&n.call(d,a,!0),n.call(this,a,!0))});a.delegate(".b-finder__row","dblclick",function(a){var b=c(this).data("b_finder_row");b&&t.call(b,a);t.call(this,a)});return b}function w(b,a,d){var e= d.finder_cols&&"number"==typeof d.finder_cols&&5>d.finder_cols&&0<d.finder_cols?d.finder_cols:4,g=0,h=c(".b-finder__hat",this),f=c('<div class="b-finder__cols"></div>'),i=c('<div class="b-finder__scroll"></div>'),n=c('<div class="b-finder__found"></div>'),m={},j={},o,l,k;h.after(f.addClass("b-finder__cols_id_"+b).addClass("b-finder__cols_x_"+e).addClass("b-finder__cols_mode_watch").data("b_finder_params",d));for(l in a)f.data("b_finder_"+l,a[l]);f.append(i);a=a.load(d);for(l=0;l<a.total;l++){k=a.items[l]; o=k.level;h=k.name;e="root";b=k.id;if(k.parentId)e=k.parentId;else if(k.parent_id)e=k.parent_id;else if(k.pid)e=k.pid;m[o]||(m[o]=u.call(i,o),g<o&&(g=o));j[e]||(j[e]=y.call(m[o],e));e=z.call(j[e],b,e,h);d.finder_selected&&-1<d.finder_selected.indexOf(b)&&e.addClass("b-finder__row_selected_yes")}for(l in j)c(".b-finder__row_id_"+j[l].data("id"),f).addClass("b-finder__row_expandable_yes");c(".b-finder__col_level_1",f).append(n);d.finder_holder||u.call(i,g+1);return f}function u(b){var b=c('<div class="b-finder__col"></div>').addClass("b-finder__col_level_"+ b).data("level",b),a=this.css("width").replace("px","")-0;this.append(b);a+=b.css("width").replace("px","")-0+(b.css("margin-right").replace("px","")-0)+(b.css("margin-left").replace("px","")-0);this.css("width",a+"px");return b}function y(b){var a=c('<div class="b-finder__group b-finder__group_id_'+b+'"></div>').data("id",b);"root"==b&&a.addClass("b-finder__group_expanded_yes");this.append(a);return a}function z(b,a,d){b=c('<div class="b-finder__row b-finder__row_id_'+b+'"></div>').text(d).attr("title", d.toLowerCase()).data({id:b,pid:a});this.append(b);return b}function n(b,a,d){var a=a||!1,d=d||!1,e=c(this),g=e.closest(".b-finder__group"),h=e.closest(".b-finder__col"),f=h.closest(".b-finder__scroll").closest(".b-finder__cols"),i=e.hasClass("b-finder__row_expandable_yes")?!0:!1,p=e.data("id"),m=g.data("id"),j=h.data("level");f.data("b_finder_prescroll");var o=f.hasClass("b-finder__cols_mode_search")?"search":"watch",l=j-1,k=c(".b-finder__row_id_"+m,f).get(0),q=f.data("b_finder_click");a&&(h.focus(), "function"==typeof q&&q.call(this,b,{id:p,pid:m,next:j+1,name:e.text(),expandable:i},f.data("b_finder_params")),c(".b-finder__group_expanded_yes",f).removeClass("b-finder__group_expanded_yes"),c(".b-finder__row_expanded_yes",f).removeClass("b-finder__row_expanded_yes"),i&&c(".b-finder__group_id_"+p,f).addClass("b-finder__group_expanded_yes"),f.addClass("b-finder__cols_active_yes"));e.addClass("b-finder__row_expanded_yes");g.addClass("b-finder__group_expanded_yes");"watch"==o&&a&&!d&&f.data("b_finder_scroll", setTimeout(function(){f.scrollLeft((h.css("width").replace("px","")-0+(h.css("margin-left").replace("px","")-0)+(h.css("margin-right").replace("px","")-0))*l)},200));"watch"==o&&!a&&(h.scrollTop(e.offset().top-g.offset().top),1==j&&f.removeData("b_finder_prescroll"));1<j&&n.call(k,b,!1)}function t(b){var a=c(this),d=a.closest(".b-finder__group"),e=a.closest(".b-finder__col"),g=e.closest(".b-finder__cols");g.data("b_finder_multiple");var h=g.data("b_finder_dblclick"),f=g.data("b_finder_scroll"),i= g.data("b_finder_params"),n=i.finder_multiple&&b.ctrlKey||i.finder_multiple&&b.metaKey?!1:!0,e=e.data("level")-0+1,m=a.hasClass("b-finder__row_selected_yes")?"cancel":"approve",d=d.data("id"),j=a.data("id");f&&clearTimeout(f);"function"==typeof h&&(n&&"approve"==m&&g.data("b_finder_clear",!0),"cancel"==m&&a.addClass("b-finder__row_cancel_yes"),a.addClass("b-finder__row_loading_yes"),h.call(this,b,{hide:c.proxy(p,g.closest(".b-finder")),done:c.proxy(A,a),undone:c.proxy(B,a)},{id:j,pid:d,next:e,name:a.text(), action:m,expandable:a.hasClass("b-finder__row_expandable_yes")?!0:!1},i))}function r(){var b=null;(b=c(".b-finder__row_selected_yes:first",this).get(0))||(b=c(".b-finder__group_id_root .b-finder__row:first",this).get(0));return b}function A(){var b=this.closest(".b-finder__cols");b.data("b_finder_clear")&&(c(".b-finder__row_selected_yes",b).removeClass("b-finder__row_selected_yes"),b.removeData("b_finder_clear"));this.hasClass("b-finder__row_cancel_yes")?this.removeClass("b-finder__row_selected_yes"): this.addClass("b-finder__row_selected_yes");this.removeClass("b-finder__row_loading_yes").removeClass("b-finder__row_cancel_yes");n.call(this,null,!0,!0)}function B(){this.removeClass("b-finder__row_loading_yes").addClass("b-finder__row_expanded_yes")}function s(){var b=c(this),a=c(".b-finder__cols_active_yes",b.closest(".b-finder__window")),d=null,e=null,g=c(".b-finder__found",a).empty(),h=0,f="",i="";a.removeClass("b-finder__cols_mode_watch").addClass("b-finder__cols_mode_search").scrollLeft(0); b.hasClass("b-finder__field")?(i=b.val(),h=i.length,e=0<h?c('.b-finder__row[title^="'+i.toLowerCase()+'"],.b-finder__row[title*=" '+i.toLowerCase()+'"]',a):c(".b-finder__row",a)):e=c(".b-finder__row_selected_yes",a);e&&0<e.length&&e.each(function(){d=c(this).clone().removeClass("b-finder__row_expandable_yes").removeClass("b-finder__row_expanded_yes").removeClass("b-finder__row_loading_yes").data("b_finder_row",this);0<h&&d.html(d.text().replace(RegExp("(^| )("+i+")","i"),'$1<span class="b-finder__highlight">$2</span>')); (f=c(".b-finder__group .b-finder__row_id_"+c(this).data("pid"),a).text())&&d.prepend(f+" > ");g.append(d)})}function q(b){var a=c(this).closest(".b-finder"),a=c(".b-finder__window",a),d=c(".b-finder__cols_active_yes",a),e=null;d.removeClass("b-finder__cols_mode_search").addClass("b-finder__cols_mode_watch");c(".b-finder__found",d).empty();c(".b-finder__field",a).val("").blur();c(".b-finder__filter",a).removeClass("b-finder__filter_active_yes");e=r.call(d);n.call(e,b)}c.fn.finder=function(b,a,c){var c= c||{},a=a||{items_load:function(){return[]}},e=this;0==e.length&&(e=x());e.hasClass("b-finder_hidden_yes")?v.call(e,b,a,c):p.call(e);return this}})(jQuery);