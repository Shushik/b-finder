/**
 * b-finder script
 *
 * @version 3.0
 * @author  Shushik <silkleopard@yandex.ru>
 * @page    http://github.com/Shushik/b-finder
 */
(function(c){function w(d,a,b){var e=c(window),f=c(".b-finder__cols_id_"+d,this),g=null;e.bind("keydown.b_finder_hide",function(a){var b=c(".b-finder"),e=c(".b-finder__cols_active_yes"),d=e.hasClass("b-finder__cols_mode_search")?"search":"watch",f=a.keyCode;f==27&&d=="search"?(a.stopPropagation(),r.call(e.get(0),a)):f==27&&p.call(b)});c(".b-finder__hat",this).html(b.finder_lang&&b.finder_lang.hat?b.finder_lang.hat:"&nbsp;");c(".b-finder__hint",this).html(b.finder_lang&&b.finder_lang.hint?b.finder_lang.hint: "&nbsp;");c(".b-finder__field",this).attr("placeholder",b.finder_lang&&b.finder_lang.search?b.finder_lang.search:"");c(".b-finder__filter",this).attr("title",b.finder_lang&&b.finder_lang.selected?b.finder_lang.selected:"");f.length==0&&(f=x.call(this,d,a,b));f.data("b_finder_prescroll",true);g=s.call(f);c(g).mousedown();this.removeClass("b-finder_hidden_yes")}function p(){c(window).unbind("keydown.b_finder_hide");this.addClass("b-finder_hidden_yes");c(".b-finder__cols_active_yes",this).removeClass("b-finder__cols_active_yes")} function y(){var d=c('<table class="b-finder b-finder_hidden_yes"><tr><td class="b-finder__valign"><div class="b-finder__window"><div class="b-finder__search"><div class="b-finder__filter"></div><div class="b-finder__clear">\u00d7</div><input class="b-finder__field" type="search"></div><div class="b-finder__hide">\u00d7</div><div class="b-finder__hat"></div><div class="b-finder__hint"></div></div></td></tr></table>'),a=c(".b-finder__window",d),b=c(".b-finder__hide",a);c("body").append(d);d.click(function(){p.call(c(this))}); b.click(function(){p.call(c(this).closest(".b-finder"))});a.click(function(a){a.stopPropagation()});a.delegate(".b-finder__field","keydown",function(a){var b=c(this),d=b.data("b_finder_search"),a=a.keyCode;d&&clearTimeout(d);b.hasClass("b-finder__field")&&a!=37&&a!=38&&a!=39&&a!=40&&a!=27&&b.data("b_finder_search",setTimeout(c.proxy(t,this),300))});a.delegate(".b-finder__filter","click",function(a){var b=c(this);b.hasClass("b-finder__filter_active_yes")?(b.removeClass("b-finder__filter_active_yes"), r.call(this,a)):(b.addClass("b-finder__filter_active_yes"),t.call(this))});a.delegate(".b-finder__clear","click",r);a.delegate(".b-finder__col","mouseover",function(){c(this).focus()});a.delegate(".b-finder__row","mousedown",function(a){var b=c(this),d=b.closest(".b-finder__cols"),h=this,i=d.data("clicked"),j=b.closest(".b-finder__found").length>0?b.data("b_finder_link"):null;i?i&&(i&&(clearInterval(i),d.removeData("clicked")),j&&u.call(j,a),u.call(h,a)):d.data("clicked",setTimeout(function(){d.removeData("clicked"); j&&q.call(j,a,true);q.call(h,a,true)},200))});return d}function x(d,a,b){var e=b.finder_cols&&typeof b.finder_cols=="number"&&b.finder_cols<5&&b.finder_cols>0?b.finder_cols:4,f=0,g=c(".b-finder__hat",this),h=c('<div class="b-finder__cols"></div>'),i=c('<div class="b-finder__scroll"></div>'),j=c('<div class="b-finder__found"></div>'),m={},o={},n,l,k;g.after(h.addClass("b-finder__cols_id_"+d).addClass("b-finder__cols_x_"+e).addClass("b-finder__cols_mode_watch").data("b_finder_params",b));for(l in a)h.data("b_finder_"+ l,a[l]);h.append(i);a=a.load(b);for(l=0;l<a.total;l++){k=a.items[l];n=k.level;g=k.name;e="root";d=k.id;if(k.parentId)e=k.parentId;else if(k.parent_id)e=k.parent_id;else if(k.pid)e=k.pid;m[n]||(m[n]=v.call(i,n),f<n&&(f=n));o[e]||(o[e]=z.call(m[n],e));e=A.call(o[e],d,e,g);b.finder_selected&&b.finder_selected.indexOf(d)>-1&&e.addClass("b-finder__row_selected_yes")}for(l in o)c(".b-finder__row_id_"+o[l].data("id"),h).addClass("b-finder__row_expandable_yes");c(".b-finder__col_level_1",h).append(j);b.finder_holder|| v.call(i,f+1);return h}function v(d){var d=c('<div class="b-finder__col"></div>').addClass("b-finder__col_level_"+d).data("level",d),a=this.css("width").replace("px","")-0;this.append(d);a+=d.css("width").replace("px","")-0+(d.css("margin-right").replace("px","")-0)+(d.css("margin-left").replace("px","")-0);this.css("width",a+"px");return d}function z(d){var a=c('<div class="b-finder__group b-finder__group_id_'+d+'"></div>').data("id",d);d=="root"&&a.addClass("b-finder__group_expanded_yes");this.append(a); return a}function A(d,a,b){d=c('<div class="b-finder__row b-finder__row_id_'+d+'"></div>').text(b).attr("title",b.toLowerCase()).data({id:d,pid:a});this.append(d);return d}function q(d,a){var a=a||false,b=c(this),e=b.closest(".b-finder__group"),f=b.closest(".b-finder__col"),g=f.closest(".b-finder__scroll").closest(".b-finder__cols"),h=b.hasClass("b-finder__row_expandable_yes")?true:false,i=b.data("id"),j=e.data("id"),m=f.data("level");g.data("b_finder_prescroll");var o=g.hasClass("b-finder__cols_mode_search")? "search":"watch",n=m-1,l=c(".b-finder__row_id_"+j,g).get(0),k=g.data("b_finder_click");a&&(f.focus(),typeof k=="function"&&k.call(this,d,{id:i,pid:j,next:m+1,name:b.text(),expandable:h},g.data("b_finder_params")),c(".b-finder__group_expanded_yes",g).removeClass("b-finder__group_expanded_yes"),c(".b-finder__row_expanded_yes",g).removeClass("b-finder__row_expanded_yes"),h&&c(".b-finder__group_id_"+i,g).addClass("b-finder__group_expanded_yes"),g.addClass("b-finder__cols_active_yes"));b.hasClass("b-finder__row_selected_yes")|| b.addClass("b-finder__row_expanded_yes");e.addClass("b-finder__group_expanded_yes");o=="watch"&&a&&g.scrollLeft((f.css("width").replace("px","")-0+(f.css("margin-left").replace("px","")-0)+(f.css("margin-right").replace("px","")-0))*n);o=="watch"&&!a&&(f.scrollTop(b.offset().top-e.offset().top),m==1&&g.removeData("b_finder_prescroll"));m>1&&q.call(l,d,false)}function u(d){var a=c(this),b=a.closest(".b-finder__group"),e=a.closest(".b-finder__col"),f=e.closest(".b-finder__cols");f.data("b_finder_multiple"); f.data("b_finder_occupied");var g=f.data("b_finder_dblclick"),h=f.data("b_finder_params"),i=h.finder_multiple&&d.ctrlKey||h.finder_multiple&&d.metaKey?false:true,e=e.data("level")-0+1,j=a.hasClass("b-finder__row_selected_yes")?"cancel":"approve",b=b.data("id"),m=a.data("id");typeof g=="function"&&(i&&j=="approve"&&f.data("b_finder_clear",true),j=="cancel"&&a.addClass("b-finder__row_cancel_yes"),a.addClass("b-finder__row_loading_yes"),g.call(this,d,{hide:c.proxy(p,f.closest(".b-finder")),done:c.proxy(B, a),undone:c.proxy(C,a)},{id:m,pid:b,next:e,name:a.text(),action:j,expandable:a.hasClass("b-finder__row_expandable_yes")?true:false},h))}function s(){var d=null;(d=c(".b-finder__row_selected_yes:first",this).get(0))||(d=c(".b-finder__group_id_root .b-finder__row:first",this).get(0));return d}function B(){var d=this.closest(".b-finder__cols");d.data("b_finder_clear")&&(c(".b-finder__row_selected_yes",d).removeClass("b-finder__row_selected_yes"),d.removeData("b_finder_clear"));this.hasClass("b-finder__row_cancel_yes")? this.removeClass("b-finder__row_selected_yes"):this.addClass("b-finder__row_selected_yes");this.removeClass("b-finder__row_loading_yes").removeClass("b-finder__row_cancel_yes");q.call(this,null,true)}function C(){this.removeClass("b-finder__row_loading_yes").addClass("b-finder__row_expanded_yes")}function t(){var d=c(this),a=c(".b-finder__cols_active_yes",d.closest(".b-finder__window")),b=null,e=null,f=c(".b-finder__found",a).empty(),g=0,h="",i="";a.removeClass("b-finder__cols_mode_watch").addClass("b-finder__cols_mode_search").scrollLeft(0); d.hasClass("b-finder__field")?(i=d.val(),g=i.length,e=g>0?c('.b-finder__row[title^="'+i.toLowerCase()+'"],.b-finder__row[title*=" '+i.toLowerCase()+'"]',a):c(".b-finder__row",a)):e=c(".b-finder__row_selected_yes",a);e&&e.length>0&&e.each(function(){b=c(this).clone().removeClass("b-finder__row_expandable_yes").removeClass("b-finder__row_expanded_yes").removeClass("b-finder__row_loading_yes").data("b_finder_link",this);g>0&&b.html(b.text().replace(RegExp("(^| )("+i+")","i"),'$1<span class="b-finder__highlight">$2</span>')); (h=c(".b-finder__group .b-finder__row_id_"+c(this).data("pid"),a).text())&&b.prepend(h+" > ");f.append(b)})}function r(d){var a=c(this).closest(".b-finder"),a=c(".b-finder__window",a),b=c(".b-finder__cols_active_yes",a),e=null;b.removeClass("b-finder__cols_mode_search").addClass("b-finder__cols_mode_watch");c(".b-finder__found",b).empty();c(".b-finder__field",a).val("").blur();c(".b-finder__filter",a).removeClass("b-finder__filter_active_yes");e=s.call(b);q.call(e,d)}c.fn.finder=function(d,a,b){var b= b||{},a=a||{items_load:function(){return[]}},c=this;c.length==0&&(c=y());c.hasClass("b-finder_hidden_yes")?w.call(c,d,a,b):p.call(c);return this}})(jQuery);