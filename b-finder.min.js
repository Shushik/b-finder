/**
 * b-finder script
 *
 * @version 3.0
 * @author  Shushik <silkleopard@yandex.ru>
 * @page    http://github.com/Shushik/b-finder
 *
 * @requires jQuery 1.6+
 */
;(function(c){function y(){var b=c(window),a=null,d=this.data("params"),e=this.data("handlers");a=c(".b-finder__cols_id_"+d.finder_id,this);b.bind("keydown.finder_keydown",function(a){var b=c(".b-finder"),e=c(".b-finder__cols_active_yes"),d=e.hasClass("b-finder__cols_mode_search")?"search":"watch",g=a.keyCode,j={38:"top",39:"right",40:"bottom",37:"left"};j[g]?(a.preventDefault(),z.call(e,a,j[g])):13==g?t.call(o.call(e,"search"==d?"first":"last"),a):27==g&&"search"==d?(a.stopPropagation(),s.call(e.get(0), a)):27==g&&q.call(b)});c(".b-finder__hat",this).html(d.finder_lang&&d.finder_lang.hat?d.finder_lang.hat:"&nbsp;");c(".b-finder__hint",this).html(d.finder_lang&&d.finder_lang.hint?d.finder_lang.hint:"&nbsp;");c(".b-finder__field",this).attr("placeholder",d.finder_lang&&d.finder_lang.search?d.finder_lang.search:"");c(".b-finder__filter",this).attr("title",d.finder_lang&&d.finder_lang.selected?d.finder_lang.selected:"");0!=a.length?u.call(a):d.finder_async?e.load.call(this,d,{done:c.proxy(v,this)}): a=v.call(this,e.load.call(this,d))}function q(){c(window).unbind("keydown.finder_keydown");this.addClass("b-finder_hidden_yes");c(".b-finder__cols_active_yes",this).removeClass("b-finder__cols_active_yes")}function A(){var b=c('<table class="b-finder b-finder_hidden_yes"><tr><td class="b-finder__valign"><div class="b-finder__window"><div class="b-finder__search"><div class="b-finder__filter"></div><div class="b-finder__clear">\u00d7</div><input class="b-finder__field" autocomplete="off" ></div><div class="b-finder__hide">\u00d7</div><div class="b-finder__hat"></div><div class="b-finder__hint"></div></div></td></tr></table>'), a=c(".b-finder__window",b),d=c(".b-finder__hide",a);c("body").append(b);b.click(function(){q.call(c(this))});d.click(function(){q.call(c(this).closest(".b-finder"))});a.click(function(a){a.stopPropagation()});a.delegate(".b-finder__field","keydown",function(a){var b=c(this),d=b.data("search"),a=a.keyCode;d&&clearTimeout(d);b.hasClass("b-finder__field")&&(40==a?b.blur():27!=a&&b.data("b_finder_search",setTimeout(c.proxy(w,this),300)))});a.delegate(".b-finder__filter","click",function(a){var b=c(this); b.hasClass("b-finder__filter_active_yes")?(b.removeClass("b-finder__filter_active_yes"),s.call(this,a)):(b.addClass("b-finder__filter_active_yes"),w.call(this))});a.delegate(".b-finder__clear","click",s);a.delegate(".b-finder__row","click",function(a){k.call(this,a,!0)});a.delegate(".b-finder__row","dblclick",function(a){t.call(this,a)});return b}function u(){var b=this.closest(".b-finder"),a=null;this.data("prescroll",!0);a=o.call(this);k.call(a,null,!0);b.removeClass("b-finder_hidden_yes")}function v(b){var a= 4,d=0,e=0,e=c(".b-finder__hat",this),f=c('<div class="b-finder__cols"></div>'),i=c('<div class="b-finder__scroll"></div>'),h=c('<div class="b-finder__found"></div>'),r={},g={},j=this.data("params");this.data("handlers");var l,k,n,p,m;if(j.finder_cols&&5>j.finder_cols&&0<j.finder_cols)a=j.finder_cols;e.after(f.addClass("b-finder__cols_id_"+j.finder_id).addClass("b-finder__cols_x_"+a).addClass("b-finder__cols_mode_watch"));f.append(i);e=b.length;for(p=0;p<e;p++){m=b[p];n=m.level;k=m.name;l="root";a= m.id;if(m.parentId)l=m.parentId;else if(m.parent_id)l=m.parent_id;else if(m.pid)l=m.pid;r[n]||(r[n]=x.call(i,n),d<n&&(d=n));g[l]||(g[l]=B.call(r[n],l));l=C.call(g[l],a,l,k);j.finder_selected&&-1<c.inArray(a,j.finder_selected)&&l.addClass("b-finder__row_expanded_yes").addClass("b-finder__row_selected_yes")}for(p in g)c(".b-finder__row_id_"+g[p].data("id"),f).addClass("b-finder__row_expandable_yes");c(".b-finder__col_level_1",f).append(h);j.finder_holder||x.call(i,d+1);u.call(f)}function x(b){var b= c('<div class="b-finder__col"></div>').addClass("b-finder__col_level_"+b).data("level",b),a=this.css("width").replace("px","")-0;this.append(b);a+=b.css("width").replace("px","")-0+(b.css("margin-right").replace("px","")-0)+(b.css("margin-left").replace("px","")-0);this.css("width",a+"px");return b}function B(b){var a=c('<div class="b-finder__group b-finder__group_id_'+b+'"></div>').data("id",b);"root"==b&&a.addClass("b-finder__group_expanded_yes");this.append(a);return a}function C(b,a,d){b=c('<div class="b-finder__row b-finder__row_id_'+ b+'"></div>').text(d).attr("title",d.toLowerCase()).data({id:b,pid:a});this.append(b);return b}function k(b,a,d){var a=a||!1,d=d||!1,e=c(this),f=e.closest(".b-finder__group,.b-finder__found"),i=e.closest(".b-finder__col"),h=i.closest(".b-finder__scroll").closest(".b-finder__cols"),r=h.closest(".b-finder"),g=e.hasClass("b-finder__row_expandable_yes")?!0:!1,j=e.data("id"),l=e.data("pid"),o=i.data("level");h.data("prescroll");var n=h.hasClass("b-finder__cols_mode_search")?"search":"watch",p=o-2,m=e.data("row"), q="search"==n?null:c(".b-finder__row_id_"+l,h).get(0),s=r.data("handlers");a&&(s.click&&!m&&s.click.call(this,b,{id:j,pid:l,next:o+1,name:e.text(),expandable:g},r.data("params")),c(".b-finder__group_expanded_yes",h).removeClass("b-finder__group_expanded_yes"),c(".b-finder__row_expanded_yes",h).removeClass("b-finder__row_expanded_yes"),g&&c(".b-finder__group_id_"+j,h).addClass("b-finder__group_expanded_yes"),h.addClass("b-finder__cols_active_yes"),"search"==n&&m&&k.call(m,b,!0));e.addClass("b-finder__row_expanded_yes"); m&&c(m).addClass("b-finder__row_expanded_yes");"watch"==n&&f.addClass("b-finder__group_expanded_yes");"watch"==n&&a&&!d&&h.data("b_finder_scroll",setTimeout(function(){h.scrollLeft((i.css("width").replace("px","")-0+(i.css("margin-left").replace("px","")-0)+(i.css("margin-right").replace("px","")-0))*p)},200));if("watch"==n&&!a||b&&38==b.keyCode||b&&40==b.keyCode)i.scrollTop(e.offset().top-f.offset().top),1==o&&h.removeData("prescroll");"watch"==n&&1<o&&k.call(q,b,!1)}function t(b){var a=c(this), d=a.closest(".b-finder__group"),e=a.closest(".b-finder__col"),f=e.closest(".b-finder__cols"),i=f.closest(".b-finder"),h=i.data("params"),i=i.data("handlers"),k=h.finder_multiple&&b.ctrlKey||h.finder_multiple&&b.metaKey?!1:!0,g=f.data("scroll"),e=e.data("level")-0+1,j=a.hasClass("b-finder__row_selected_yes")?"cancel":"approve",d=d.data("id"),l=a.data("id");a.data("row");g&&clearTimeout(g);i.dblclick&&(k&&"approve"==j&&f.data("clear",!0),"cancel"==j&&a.addClass("b-finder__row_cancel_yes"),a.addClass("b-finder__row_loading_yes"), i.dblclick.call(this,b,{hide:c.proxy(q,f.closest(".b-finder")),done:c.proxy(D,a.get(0)),undone:c.proxy(E,a.get(0))},{id:l,pid:d,next:e,name:a.text(),action:j,expandable:a.hasClass("b-finder__row_expandable_yes")?!0:!1},h))}function z(b,a){var d=this.hasClass("b-finder__cols_mode_search")?"search":"watch",e=c(o.call("search"==d?c(".b-finder__found",this):this,"last")),f=null;if("top"==a)f=e.prev();else if("bottom"==a)f=e.next();else if("watch"==d&&e.hasClass("b-finder__row_expandable_yes")&&"right"== a||"watch"==d&&"left"==a&&"root"!=e.data("pid"))"right"==a?f=c(o.call(c(".b-finder__group_expanded_yes:last",this),"first")):(e.removeClass("b-finder__row_expanded_yes"),f=c(".b-finder__row_id_"+e.data("pid"),this));this.data("prescroll",!0);f&&0<f.length&&k.call(f.get(0),b,!0)}function o(b){var b=b||"first",a=null;(a=c(".b-finder__row_expanded_yes:"+b,this).get(0))||(a=this.hasClass("b-finder__group")||this.hasClass("b-finder__found")?c(".b-finder__row",this).get(0):c(".b-finder__group_id_root .b-finder__row:"+ b,this).get(0));return a}function D(){var b=c(this),a=b.closest(".b-finder__cols"),d=a.data("clear"),e=b.data("row");d&&(c(".b-finder__row_selected_yes",a).removeClass("b-finder__row_selected_yes"),a.removeData("clear"));b.hasClass("b-finder__row_cancel_yes")?(b.removeClass("b-finder__row_selected_yes"),e&&c(e).removeClass("b-finder__row_selected_yes")):(b.addClass("b-finder__row_selected_yes"),e&&c(e).addClass("b-finder__row_selected_yes"));b.removeClass("b-finder__row_loading_yes").removeClass("b-finder__row_cancel_yes"); k.call(this,null,!0)}function E(){this.removeClass("b-finder__row_loading_yes");k.call(this,null,!0)}function w(){var b=c(this),a=c(".b-finder__cols_active_yes",b.closest(".b-finder__window")),d=null,e=null,f=c(".b-finder__found",a).empty(),i=0,h=0,k="",g="";a.removeClass("b-finder__cols_mode_watch").addClass("b-finder__cols_mode_search").scrollLeft(0);b.hasClass("b-finder__field")?(g=b.val(),h=g.length,e=0<h?c('.b-finder__row[title^="'+g.toLowerCase()+'"],.b-finder__row[title*=" '+g.toLowerCase()+ '"]',a):c(".b-finder__row",a)):e=c(".b-finder__row_selected_yes",a);e&&0<e.length&&e.each(function(){d=c(this).clone().removeClass("b-finder__row_expandable_yes").removeClass("b-finder__row_expanded_yes").removeClass("b-finder__row_loading_yes").data("row",this);0==i&&d.addClass("b-finder__row_expanded_yes");0<h&&d.html(d.text().replace(RegExp("(^| )("+g+")","i"),'$1<span class="b-finder__highlight">$2</span>'));(k=c(".b-finder__group .b-finder__row_id_"+c(this).data("pid"),a).text())&&d.prepend(k+ " > ");f.append(d);i++})}function s(b){var a=c(this).closest(".b-finder"),a=c(".b-finder__window",a),d=c(".b-finder__cols_active_yes",a),e=null;d.removeClass("b-finder__cols_mode_search").addClass("b-finder__cols_mode_watch");c(".b-finder__found",d).empty();c(".b-finder__field",a).val("").blur();c(".b-finder__filter",a).removeClass("b-finder__filter_active_yes");e=o.call(d,"last");k.call(e,b)}c.fn.finder=function(b,a,c){var c=c||{},a=a||{items_load:function(){return[]}},e=this;c.finder_id=b;0==e.length&& (e=A());e.hasClass("b-finder_hidden_yes")?(e.data("params",c),e.data("handlers",a),y.call(e)):q.call(e);return this}})(jQuery);