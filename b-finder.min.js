/**
 * b-finder script
 *
 * @version 3.0
 * @author  Shushik <silkleopard@yandex.ru>
 * @page    http://github.com/Shushik/b-finder
 *
 * @requires jQuery 1.4+
 */
(function(c){function w(b,a,d){var e=c(window),f=c(".b-finder__cols_id_"+b,this),h=null;e.bind("keydown.b_finder_hide",function(a){var e=c(".b-finder"),b=c(".b-finder__cols_active_yes"),d=b.hasClass("b-finder__cols_mode_search")?"search":"watch",f=a.keyCode,h={38:"top",39:"right",40:"bottom",37:"left"};h[f]?(a.preventDefault(),x.call(b,a,h[f])):13==f?t.call(r.call(b,"search"==d?"first":"last"),a):27==f&&"search"==d?(a.stopPropagation(),s.call(b.get(0),a)):27==f&&p.call(e)});c(".b-finder__hat",this).html(d.finder_lang&& d.finder_lang.hat?d.finder_lang.hat:"&nbsp;");c(".b-finder__hint",this).html(d.finder_lang&&d.finder_lang.hint?d.finder_lang.hint:"&nbsp;");c(".b-finder__field",this).attr("placeholder",d.finder_lang&&d.finder_lang.search?d.finder_lang.search:"");c(".b-finder__filter",this).attr("title",d.finder_lang&&d.finder_lang.selected?d.finder_lang.selected:"");0==f.length&&(f=y.call(this,b,a,d));f.data("b_finder_prescroll",!0);h=r.call(f);q.call(h,null,!0);this.removeClass("b-finder_hidden_yes")}function p(){c(window).unbind("keydown.b_finder_hide"); this.addClass("b-finder_hidden_yes");c(".b-finder__cols_active_yes",this).removeClass("b-finder__cols_active_yes")}function z(){var b=c('<table class="b-finder b-finder_hidden_yes"><tr><td class="b-finder__valign"><div class="b-finder__window"><div class="b-finder__search"><div class="b-finder__filter"></div><div class="b-finder__clear">\u00d7</div><input class="b-finder__field" autocomplete="off" ></div><div class="b-finder__hide">\u00d7</div><div class="b-finder__hat"></div><div class="b-finder__hint"></div></div></td></tr></table>'), a=c(".b-finder__window",b),d=c(".b-finder__hide",a);c("body").append(b);b.click(function(){p.call(c(this))});d.click(function(){p.call(c(this).closest(".b-finder"))});a.click(function(a){a.stopPropagation()});a.delegate(".b-finder__field","keydown",function(a){var b=c(this),d=b.data("b_finder_search"),a=a.keyCode;d&&clearTimeout(d);b.hasClass("b-finder__field")&&(40==a?b.blur():27!=a&&b.data("b_finder_search",setTimeout(c.proxy(u,this),300)))});a.delegate(".b-finder__filter","click",function(a){var b= c(this);b.hasClass("b-finder__filter_active_yes")?(b.removeClass("b-finder__filter_active_yes"),s.call(this,a)):(b.addClass("b-finder__filter_active_yes"),u.call(this))});a.delegate(".b-finder__clear","click",s);a.delegate(".b-finder__row","click",function(a){q.call(this,a,!0)});a.delegate(".b-finder__row","dblclick",function(a){t.call(this,a)});return b}function y(b,a,d){var e=d.finder_cols&&"number"==typeof d.finder_cols&&5>d.finder_cols&&0<d.finder_cols?d.finder_cols:4,f=0,h=c(".b-finder__hat", this),g=c('<div class="b-finder__cols"></div>'),k=c('<div class="b-finder__scroll"></div>'),l=c('<div class="b-finder__found"></div>'),o={},m={},j,n,i;h.after(g.addClass("b-finder__cols_id_"+b).addClass("b-finder__cols_x_"+e).addClass("b-finder__cols_mode_watch").data("b_finder_params",d));for(n in a)g.data("b_finder_"+n,a[n]);g.append(k);a=a.load(d);for(n=0;n<a.total;n++){i=a.items[n];j=i.level;h=i.name;e="root";b=i.id;if(i.parentId)e=i.parentId;else if(i.parent_id)e=i.parent_id;else if(i.pid)e= i.pid;o[j]||(o[j]=v.call(k,j),f<j&&(f=j));m[e]||(m[e]=A.call(o[j],e));e=B.call(m[e],b,e,h);d.finder_selected&&-1<c.inArray(d.finder_selected,b)&&e.addClass("b-finder__row_selected_yes")}for(n in m)c(".b-finder__row_id_"+m[n].data("id"),g).addClass("b-finder__row_expandable_yes");c(".b-finder__col_level_1",g).append(l);d.finder_holder||v.call(k,f+1);return g}function v(b){var b=c('<div class="b-finder__col"></div>').addClass("b-finder__col_level_"+b).data("level",b),a=this.css("width").replace("px", "")-0;this.append(b);a+=b.css("width").replace("px","")-0+(b.css("margin-right").replace("px","")-0)+(b.css("margin-left").replace("px","")-0);this.css("width",a+"px");return b}function A(b){var a=c('<div class="b-finder__group b-finder__group_id_'+b+'"></div>').data("id",b);"root"==b&&a.addClass("b-finder__group_expanded_yes");this.append(a);return a}function B(b,a,d){b=c('<div class="b-finder__row b-finder__row_id_'+b+'"></div>').text(d).attr("title",d.toLowerCase()).data({id:b,pid:a});this.append(b); return b}function q(b,a,d){var a=a||!1,d=d||!1,e=c(this),f=e.closest(".b-finder__group,.b-finder__found"),h=e.closest(".b-finder__col"),g=h.closest(".b-finder__scroll").closest(".b-finder__cols"),k=e.hasClass("b-finder__row_expandable_yes")?!0:!1,l=e.data("id"),o=e.data("pid"),m=h.data("level");g.data("b_finder_prescroll");var j=g.hasClass("b-finder__cols_mode_search")?"search":"watch",n=m-2,i=e.data("b_finder_row"),r="search"==j?null:c(".b-finder__row_id_"+o,g).get(0),p=g.data("b_finder_click"); a&&(h.focus(),"function"==typeof p&&!i&&p.call(this,b,{id:l,pid:o,next:m+1,name:e.text(),expandable:k},g.data("b_finder_params")),c(".b-finder__group_expanded_yes",g).removeClass("b-finder__group_expanded_yes"),c(".b-finder__row_expanded_yes",g).removeClass("b-finder__row_expanded_yes"),k&&c(".b-finder__group_id_"+l,g).addClass("b-finder__group_expanded_yes"),g.addClass("b-finder__cols_active_yes"),"search"==j&&i&&q.call(i,b,!0));e.addClass("b-finder__row_expanded_yes");i&&c(i).addClass("b-finder__row_expanded_yes"); "watch"==j&&f.addClass("b-finder__group_expanded_yes");"watch"==j&&a&&!d&&g.data("b_finder_scroll",setTimeout(function(){g.scrollLeft((h.css("width").replace("px","")-0+(h.css("margin-left").replace("px","")-0)+(h.css("margin-right").replace("px","")-0))*n)},200));if("watch"==j&&!a||b&&38==b.keyCode||b&&40==b.keyCode)h.scrollTop(e.offset().top-f.offset().top),1==m&&g.removeData("b_finder_prescroll");"watch"==j&&1<m&&q.call(r,b,!1)}function t(b){var a=c(this),d=a.closest(".b-finder__group"),e=a.closest(".b-finder__col"), f=e.closest(".b-finder__cols");f.data("b_finder_multiple");var h=f.data("b_finder_dblclick"),g=f.data("b_finder_scroll"),k=f.data("b_finder_params"),l=k.finder_multiple&&b.ctrlKey||k.finder_multiple&&b.metaKey?!1:!0,e=e.data("level")-0+1,o=a.hasClass("b-finder__row_selected_yes")?"cancel":"approve",d=d.data("id"),m=a.data("id");a.data("b_finder_row");g&&clearTimeout(g);"function"==typeof h&&(l&&"approve"==o&&f.data("b_finder_clear",!0),"cancel"==o&&a.addClass("b-finder__row_cancel_yes"),a.addClass("b-finder__row_loading_yes"), h.call(this,b,{hide:c.proxy(p,f.closest(".b-finder")),done:c.proxy(C,a.get(0)),undone:c.proxy(D,a.get(0))},{id:m,pid:d,next:e,name:a.text(),action:o,expandable:a.hasClass("b-finder__row_expandable_yes")?!0:!1},k))}function x(b,a){var d=this.hasClass("b-finder__cols_mode_search")?"search":"watch",e=c(r.call("search"==d?c(".b-finder__found",this):this,"last")),f=null;if("top"==a)f=e.prev();else if("bottom"==a)f=e.next();else if("watch"==d&&e.hasClass("b-finder__row_expandable_yes")&&"right"==a||"watch"== d&&"left"==a&&"root"!=e.data("pid"))"right"==a?f=c(r.call(c(".b-finder__group_expanded_yes:last",this),"first")):(e.removeClass("b-finder__row_expanded_yes"),f=c(".b-finder__row_id_"+e.data("pid"),this));this.data("b_finder_prescroll",!0);f&&0<f.length&&q.call(f.get(0),b,!0)}function r(b){var b=b||"first",a=null;(a=c(".b-finder__row_expanded_yes:"+b,this).get(0))||(a=this.hasClass("b-finder__group")||this.hasClass("b-finder__found")?c(".b-finder__row",this).get(0):c(".b-finder__group_id_root .b-finder__row:"+ b,this).get(0));return a}function C(){var b=c(this),a=b.closest(".b-finder__cols"),d=a.data("b_finder_clear"),e=b.data("b_finder_row");d&&(c(".b-finder__row_selected_yes",a).removeClass("b-finder__row_selected_yes"),a.removeData("b_finder_clear"));b.hasClass("b-finder__row_cancel_yes")?(b.removeClass("b-finder__row_selected_yes"),e&&c(e).removeClass("b-finder__row_selected_yes")):(b.addClass("b-finder__row_selected_yes"),e&&c(e).addClass("b-finder__row_selected_yes"));b.removeClass("b-finder__row_loading_yes").removeClass("b-finder__row_cancel_yes"); q.call(this,null,!0)}function D(){this.removeClass("b-finder__row_loading_yes");q.call(this,null,!0)}function u(){var b=c(this),a=c(".b-finder__cols_active_yes",b.closest(".b-finder__window")),d=null,e=null,f=c(".b-finder__found",a).empty(),h=0,g=0,k="",l="";a.removeClass("b-finder__cols_mode_watch").addClass("b-finder__cols_mode_search").scrollLeft(0);b.hasClass("b-finder__field")?(l=b.val(),g=l.length,e=0<g?c('.b-finder__row[title^="'+l.toLowerCase()+'"],.b-finder__row[title*=" '+l.toLowerCase()+ '"]',a):c(".b-finder__row",a)):e=c(".b-finder__row_selected_yes",a);e&&0<e.length&&e.each(function(){d=c(this).clone().removeClass("b-finder__row_expandable_yes").removeClass("b-finder__row_expanded_yes").removeClass("b-finder__row_loading_yes").data("b_finder_row",this);0==h&&d.addClass("b-finder__row_expanded_yes");0<g&&d.html(d.text().replace(RegExp("(^| )("+l+")","i"),'$1<span class="b-finder__highlight">$2</span>'));(k=c(".b-finder__group .b-finder__row_id_"+c(this).data("pid"),a).text())&&d.prepend(k+ " > ");f.append(d);h++})}function s(b){var a=c(this).closest(".b-finder"),a=c(".b-finder__window",a),d=c(".b-finder__cols_active_yes",a),e=null;d.removeClass("b-finder__cols_mode_search").addClass("b-finder__cols_mode_watch");c(".b-finder__found",d).empty();c(".b-finder__field",a).val("").blur();c(".b-finder__filter",a).removeClass("b-finder__filter_active_yes");e=r.call(d,"last");q.call(e,b)}c.fn.finder=function(b,a,c){var c=c||{},a=a||{items_load:function(){return[]}},e=this;0==e.length&&(e=z()); e.hasClass("b-finder_hidden_yes")?w.call(e,b,a,c):p.call(e);return this}})(jQuery);