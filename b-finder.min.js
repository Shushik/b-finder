/**
 * b-finder script
 *
 * @version 3.0
 * @author  Shushik <silkleopard@yandex.ru>
 * @page    http://github.com/Shushik/b-finder
 *
 * @requires jQuery 1.4+
 */
(function(c){function x(b,a,d){var e=c(window),f=c(".b-finder__cols_id_"+b,this),h=null;e.bind("keydown.b_finder_hide",function(a){var e=c(".b-finder"),b=c(".b-finder__cols_active_yes"),d=b.hasClass("b-finder__cols_mode_search")?"search":"watch",f=a.keyCode,h={38:"top",39:"right",40:"bottom",37:"left"};h[f]?(a.preventDefault(),y.call(b,a,h[f])):13==f?u.call(q.call(b,"search"==d?"first":"last"),a):27==f&&"search"==d?(a.stopPropagation(),t.call(b.get(0),a)):27==f&&s.call(e)});c(".b-finder__hat",this).html(d.finder_lang&& d.finder_lang.hat?d.finder_lang.hat:"&nbsp;");c(".b-finder__hint",this).html(d.finder_lang&&d.finder_lang.hint?d.finder_lang.hint:"&nbsp;");c(".b-finder__field",this).attr("placeholder",d.finder_lang&&d.finder_lang.search?d.finder_lang.search:"");c(".b-finder__filter",this).attr("title",d.finder_lang&&d.finder_lang.selected?d.finder_lang.selected:"");0==f.length&&(f=z.call(this,b,a,d));f.data("b_finder_prescroll",!0);h=q.call(f);r.call(h,null,!0);this.removeClass("b-finder_hidden_yes")}function s(){c(window).unbind("keydown.b_finder_hide"); this.addClass("b-finder_hidden_yes");c(".b-finder__cols_active_yes",this).removeClass("b-finder__cols_active_yes")}function A(){var b=c('<table class="b-finder b-finder_hidden_yes"><tr><td class="b-finder__valign"><div class="b-finder__window"><div class="b-finder__search"><div class="b-finder__filter"></div><div class="b-finder__clear">\u00d7</div><input class="b-finder__field" autocomplete="off" ></div><div class="b-finder__hide">\u00d7</div><div class="b-finder__hat"></div><div class="b-finder__hint"></div></div></td></tr></table>'), a=c(".b-finder__window",b),d=c(".b-finder__hide",a);c("body").append(b);b.click(function(){s.call(c(this))});d.click(function(){s.call(c(this).closest(".b-finder"))});a.click(function(a){a.stopPropagation()});a.delegate(".b-finder__field","keydown",function(a){var b=c(this),d=b.data("b_finder_search"),a=a.keyCode;d&&clearTimeout(d);b.hasClass("b-finder__field")&&(40==a?b.blur():27!=a&&b.data("b_finder_search",setTimeout(c.proxy(v,this),300)))});a.delegate(".b-finder__filter","click",function(a){var b= c(this);b.hasClass("b-finder__filter_active_yes")?(b.removeClass("b-finder__filter_active_yes"),t.call(this,a)):(b.addClass("b-finder__filter_active_yes"),v.call(this))});a.delegate(".b-finder__clear","click",t);a.delegate(".b-finder__row","click",function(a){r.call(this,a,!0)});a.delegate(".b-finder__row","dblclick",function(a){u.call(this,a)});return b}function z(b,a,d){var e=d.finder_cols&&"number"==typeof d.finder_cols&&5>d.finder_cols&&0<d.finder_cols?d.finder_cols:4,f=0,h=0,h=c(".b-finder__hat", this),g=c('<div class="b-finder__cols"></div>'),j=c('<div class="b-finder__scroll"></div>'),k=c('<div class="b-finder__found"></div>'),n={},l={},o,p,i,m;h.after(g.addClass("b-finder__cols_id_"+b).addClass("b-finder__cols_x_"+e).addClass("b-finder__cols_mode_watch").data("b_finder_params",d));for(i in a)g.data("b_finder_"+i,a[i]);g.append(j);a=a.load(d);h=a.length;for(i=0;i<h;i++){m=a[i];p=m.level;o=m.name;e="root";b=m.id;if(m.parentId)e=m.parentId;else if(m.parent_id)e=m.parent_id;else if(m.pid)e= m.pid;n[p]||(n[p]=w.call(j,p),f<p&&(f=p));l[e]||(l[e]=B.call(n[p],e));e=C.call(l[e],b,e,o);d.finder_selected&&-1<c.inArray(b,d.finder_selected)&&(console.log("test"),e.addClass("b-finder__row_selected_yes"))}for(i in l)c(".b-finder__row_id_"+l[i].data("id"),g).addClass("b-finder__row_expandable_yes");c(".b-finder__col_level_1",g).append(k);d.finder_holder||w.call(j,f+1);return g}function w(b){var b=c('<div class="b-finder__col"></div>').addClass("b-finder__col_level_"+b).data("level",b),a=this.css("width").replace("px", "")-0;this.append(b);a+=b.css("width").replace("px","")-0+(b.css("margin-right").replace("px","")-0)+(b.css("margin-left").replace("px","")-0);this.css("width",a+"px");return b}function B(b){var a=c('<div class="b-finder__group b-finder__group_id_'+b+'"></div>').data("id",b);"root"==b&&a.addClass("b-finder__group_expanded_yes");this.append(a);return a}function C(b,a,d){b=c('<div class="b-finder__row b-finder__row_id_'+b+'"></div>').text(d).attr("title",d.toLowerCase()).data({id:b,pid:a});this.append(b); return b}function r(b,a,d){var a=a||!1,d=d||!1,e=c(this),f=e.closest(".b-finder__group,.b-finder__found"),h=e.closest(".b-finder__col"),g=h.closest(".b-finder__scroll").closest(".b-finder__cols"),j=e.hasClass("b-finder__row_expandable_yes")?!0:!1,k=e.data("id"),n=e.data("pid"),l=h.data("level");g.data("b_finder_prescroll");var o=g.hasClass("b-finder__cols_mode_search")?"search":"watch",p=l-2,i=e.data("b_finder_row"),m="search"==o?null:c(".b-finder__row_id_"+n,g).get(0),q=g.data("b_finder_click"); a&&(h.focus(),"function"==typeof q&&!i&&q.call(this,b,{id:k,pid:n,next:l+1,name:e.text(),expandable:j},g.data("b_finder_params")),c(".b-finder__group_expanded_yes",g).removeClass("b-finder__group_expanded_yes"),c(".b-finder__row_expanded_yes",g).removeClass("b-finder__row_expanded_yes"),j&&c(".b-finder__group_id_"+k,g).addClass("b-finder__group_expanded_yes"),g.addClass("b-finder__cols_active_yes"),"search"==o&&i&&r.call(i,b,!0));e.addClass("b-finder__row_expanded_yes");i&&c(i).addClass("b-finder__row_expanded_yes"); "watch"==o&&f.addClass("b-finder__group_expanded_yes");"watch"==o&&a&&!d&&g.data("b_finder_scroll",setTimeout(function(){g.scrollLeft((h.css("width").replace("px","")-0+(h.css("margin-left").replace("px","")-0)+(h.css("margin-right").replace("px","")-0))*p)},200));if("watch"==o&&!a||b&&38==b.keyCode||b&&40==b.keyCode)h.scrollTop(e.offset().top-f.offset().top),1==l&&g.removeData("b_finder_prescroll");"watch"==o&&1<l&&r.call(m,b,!1)}function u(b){var a=c(this),d=a.closest(".b-finder__group"),e=a.closest(".b-finder__col"), f=e.closest(".b-finder__cols");f.data("b_finder_multiple");var h=f.data("b_finder_dblclick"),g=f.data("b_finder_scroll"),j=f.data("b_finder_params"),k=j.finder_multiple&&b.ctrlKey||j.finder_multiple&&b.metaKey?!1:!0,e=e.data("level")-0+1,n=a.hasClass("b-finder__row_selected_yes")?"cancel":"approve",d=d.data("id"),l=a.data("id");a.data("b_finder_row");g&&clearTimeout(g);"function"==typeof h&&(k&&"approve"==n&&f.data("b_finder_clear",!0),"cancel"==n&&a.addClass("b-finder__row_cancel_yes"),a.addClass("b-finder__row_loading_yes"), h.call(this,b,{hide:c.proxy(s,f.closest(".b-finder")),done:c.proxy(D,a.get(0)),undone:c.proxy(E,a.get(0))},{id:l,pid:d,next:e,name:a.text(),action:n,expandable:a.hasClass("b-finder__row_expandable_yes")?!0:!1},j))}function y(b,a){var d=this.hasClass("b-finder__cols_mode_search")?"search":"watch",e=c(q.call("search"==d?c(".b-finder__found",this):this,"last")),f=null;if("top"==a)f=e.prev();else if("bottom"==a)f=e.next();else if("watch"==d&&e.hasClass("b-finder__row_expandable_yes")&&"right"==a||"watch"== d&&"left"==a&&"root"!=e.data("pid"))"right"==a?f=c(q.call(c(".b-finder__group_expanded_yes:last",this),"first")):(e.removeClass("b-finder__row_expanded_yes"),f=c(".b-finder__row_id_"+e.data("pid"),this));this.data("b_finder_prescroll",!0);f&&0<f.length&&r.call(f.get(0),b,!0)}function q(b){var b=b||"first",a=null;(a=c(".b-finder__row_expanded_yes:"+b,this).get(0))||(a=this.hasClass("b-finder__group")||this.hasClass("b-finder__found")?c(".b-finder__row",this).get(0):c(".b-finder__group_id_root .b-finder__row:"+ b,this).get(0));return a}function D(){var b=c(this),a=b.closest(".b-finder__cols"),d=a.data("b_finder_clear"),e=b.data("b_finder_row");d&&(c(".b-finder__row_selected_yes",a).removeClass("b-finder__row_selected_yes"),a.removeData("b_finder_clear"));b.hasClass("b-finder__row_cancel_yes")?(b.removeClass("b-finder__row_selected_yes"),e&&c(e).removeClass("b-finder__row_selected_yes")):(b.addClass("b-finder__row_selected_yes"),e&&c(e).addClass("b-finder__row_selected_yes"));b.removeClass("b-finder__row_loading_yes").removeClass("b-finder__row_cancel_yes"); r.call(this,null,!0)}function E(){this.removeClass("b-finder__row_loading_yes");r.call(this,null,!0)}function v(){var b=c(this),a=c(".b-finder__cols_active_yes",b.closest(".b-finder__window")),d=null,e=null,f=c(".b-finder__found",a).empty(),h=0,g=0,j="",k="";a.removeClass("b-finder__cols_mode_watch").addClass("b-finder__cols_mode_search").scrollLeft(0);b.hasClass("b-finder__field")?(k=b.val(),g=k.length,e=0<g?c('.b-finder__row[title^="'+k.toLowerCase()+'"],.b-finder__row[title*=" '+k.toLowerCase()+ '"]',a):c(".b-finder__row",a)):e=c(".b-finder__row_selected_yes",a);e&&0<e.length&&e.each(function(){d=c(this).clone().removeClass("b-finder__row_expandable_yes").removeClass("b-finder__row_expanded_yes").removeClass("b-finder__row_loading_yes").data("b_finder_row",this);0==h&&d.addClass("b-finder__row_expanded_yes");0<g&&d.html(d.text().replace(RegExp("(^| )("+k+")","i"),'$1<span class="b-finder__highlight">$2</span>'));(j=c(".b-finder__group .b-finder__row_id_"+c(this).data("pid"),a).text())&&d.prepend(j+ " > ");f.append(d);h++})}function t(b){var a=c(this).closest(".b-finder"),a=c(".b-finder__window",a),d=c(".b-finder__cols_active_yes",a),e=null;d.removeClass("b-finder__cols_mode_search").addClass("b-finder__cols_mode_watch");c(".b-finder__found",d).empty();c(".b-finder__field",a).val("").blur();c(".b-finder__filter",a).removeClass("b-finder__filter_active_yes");e=q.call(d,"last");r.call(e,b)}c.fn.finder=function(b,a,c){var c=c||{},a=a||{items_load:function(){return[]}},e=this;0==e.length&&(e=A()); e.hasClass("b-finder_hidden_yes")?x.call(e,b,a,c):s.call(e);return this}})(jQuery);