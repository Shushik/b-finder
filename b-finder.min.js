/**
 * b-finder script
 *
 * @version 3.0
 * @author  Shushik <silkleopard@yandex.ru>
 * @page    http://github.com/Shushik/b-finder
 *
 * @requires jQuery 1.6+
 */
;(function(b){function y(){var d=b(document),a=null,c=this.data("params"),e=this.data("handlers");c.finder_static&&this.addClass("b-finder_static_yes");a=b(".b-finder__cols_id_"+c.finder_id,this);d.bind("keydown.finder_keydown",function(a){var c=b(".b-finder"),d=b(".b-finder__cols_active_yes"),e=d.hasClass("b-finder__cols_mode_search")?"search":"watch",h=a.keyCode,k={38:"top",39:"right",40:"bottom",37:"left"};k[h]?(a.preventDefault(),z.call(d,a,k[h])):13==h?t.call(q.call(d,"search"==e?"first":"last"), a):27==h&&"search"==e?(a.stopPropagation(),s.call(d.get(0),a)):27==h&&r.call(c)});b(".b-finder__hat",this).html(c.finder_lang&&c.finder_lang.hat?c.finder_lang.hat:"&nbsp;");b(".b-finder__hint",this).html(c.finder_lang&&c.finder_lang.hint?c.finder_lang.hint:"&nbsp;");b(".b-finder__field",this).attr("placeholder",c.finder_lang&&c.finder_lang.search?c.finder_lang.search:"");b(".b-finder__filter",this).attr("title",c.finder_lang&&c.finder_lang.selected?c.finder_lang.selected:"");0!=a.length?u.call(a): c.finder_async?e.load.call(this,c,{done:b.proxy(v,this)}):a=v.call(this,e.load.call(this,c))}function r(){var d=this.data("params"),a=this.data("handlers");b(document).unbind("keydown.finder_keydown");this.addClass("b-finder_hidden_yes").removeClass("b-finder_static_yes");b(".b-finder__cols_active_yes",this).removeClass("b-finder__cols_active_yes");a.hide&&a.hide.call(this,d)}function A(){var d=b(this),a=b('<table class="b-finder b-finder_hidden_yes"><tr><td class="b-finder__valign"><div class="b-finder__window"><div class="b-finder__search"><div class="b-finder__filter"></div><div class="b-finder__clear">\u00d7</div><input class="b-finder__field" autocomplete="off" ></div><div class="b-finder__hide">\u00d7</div><div class="b-finder__hat"></div><div class="b-finder__hint"></div></div></td></tr></table>'), c=b(".b-finder__window",a),e=b(".b-finder__hide",c);0<d.length?d.replaceWith(a):b("body").append(a);a.click(function(){r.call(b(this))});e.click(function(){r.call(b(this).closest(".b-finder"))});c.click(function(a){a.stopPropagation()});c.delegate(".b-finder__field","keydown",function(a){var c=b(this),d=c.data("search"),a=a.keyCode;d&&clearTimeout(d);c.hasClass("b-finder__field")&&(40==a?c.blur():27!=a&&c.data("b_finder_search",setTimeout(b.proxy(w,this),300)))});c.delegate(".b-finder__filter","click", function(a){var c=b(this);c.hasClass("b-finder__filter_active_yes")?(c.removeClass("b-finder__filter_active_yes"),s.call(this,a)):(c.addClass("b-finder__filter_active_yes"),w.call(this))});c.delegate(".b-finder__clear","click",s);c.delegate(".b-finder__row","click",function(a){i.call(this,a,!0)});c.delegate(".b-finder__row","dblclick",function(a){t.call(this,a)});return a}function u(){var d=this.closest(".b-finder"),a=d.data("handlers"),c=d.data("params"),b=null;this.data("prescroll",!0);b=q.call(this); i.call(b,null,!0);d.removeClass("b-finder_hidden_yes");a.show&&a.show.call(d,c)}function v(d){var a=4,c=0,e=0,e=b(".b-finder__hat",this),f=b('<div class="b-finder__cols"></div>'),m=b('<div class="b-finder__scroll"></div>'),g=b('<div class="b-finder__found"></div>'),o={},h={},k=this.data("params");this.data("handlers");var j,p,n,i,l;if(k.finder_cols&&5>k.finder_cols&&0<k.finder_cols)a=k.finder_cols;e.after(f.addClass("b-finder__cols_id_"+k.finder_id).addClass("b-finder__cols_x_"+a).addClass("b-finder__cols_mode_watch")); f.append(m);e=d.length;for(i=0;i<e;i++){l=d[i];n=l.level;p=l.name;j="root";a=l.id;if(l.parentId)j=l.parentId;else if(l.parent_id)j=l.parent_id;else if(l.pid)j=l.pid;o[n]||(o[n]=x.call(m,n),c<n&&(c=n));h[j]||(h[j]=B.call(o[n],j));j=C.call(h[j],a,j,p);k.finder_selected&&-1<b.inArray(a,k.finder_selected)&&j.addClass("b-finder__row_expanded_yes").addClass("b-finder__row_selected_yes")}for(i in h)b(".b-finder__row_id_"+h[i].data("id"),f).addClass("b-finder__row_expandable_yes");b(".b-finder__col_level_1", f).append(g);k.finder_holder||x.call(m,c+1);u.call(f)}function x(d){var d=b('<div class="b-finder__col"></div>').addClass("b-finder__col_level_"+d).data("level",d),a=this.css("width").replace("px","")-0;this.append(d);a+=d.css("width").replace("px","")-0+(d.css("margin-right").replace("px","")-0)+(d.css("margin-left").replace("px","")-0);this.css("width",a+"px");return d}function B(d){var a=b('<div class="b-finder__group b-finder__group_id_'+d+'"></div>').data("id",d);"root"==d&&a.addClass("b-finder__group_expanded_yes"); this.append(a);return a}function C(d,a,c){d=b('<div class="b-finder__row b-finder__row_id_'+d+'"></div>').text(c).attr("data-search",c.toLowerCase()).data({id:d,pid:a});this.append(d);return d}function i(d,a,c){var a=a||!1,c=c||!1,e=b(this),f=e.closest(".b-finder__group,.b-finder__found"),m=e.closest(".b-finder__col"),g=m.closest(".b-finder__scroll").closest(".b-finder__cols"),o=g.closest(".b-finder"),h=e.hasClass("b-finder__row_expandable_yes")?!0:!1,k=e.data("id"),j=e.data("pid"),p=m.data("level"); g.data("prescroll");var n=g.hasClass("b-finder__cols_mode_search")?"search":"watch",q=p-2,l=e.data("row"),r="search"==n?null:b(".b-finder__row_id_"+j,g).get(0),s=o.data("handlers");a&&(s.click&&!l&&s.click.call(this,d,{id:k,pid:j,next:p+1,name:e.text(),expandable:h},o.data("params")),b(".b-finder__group_expanded_yes",g).removeClass("b-finder__group_expanded_yes"),b(".b-finder__row_expanded_yes",g).removeClass("b-finder__row_expanded_yes"),h&&b(".b-finder__group_id_"+k,g).addClass("b-finder__group_expanded_yes"), g.addClass("b-finder__cols_active_yes"),"search"==n&&l&&i.call(l,d,!0));e.addClass("b-finder__row_expanded_yes");l&&b(l).addClass("b-finder__row_expanded_yes");"watch"==n&&f.addClass("b-finder__group_expanded_yes");"watch"==n&&a&&!c&&g.data("b_finder_scroll",setTimeout(function(){g.scrollLeft((m.css("width").replace("px","")-0+(m.css("margin-left").replace("px","")-0)+(m.css("margin-right").replace("px","")-0))*q)},200));if("watch"==n&&!a||d&&38==d.keyCode||d&&40==d.keyCode)m.scrollTop(e.offset().top- f.offset().top),1==p&&g.removeData("prescroll");"watch"==n&&1<p&&i.call(r,d,!1)}function t(d){var a=b(this),c=a.data("row"),c=c?b(c):a,e=c.closest(".b-finder__group"),f=c.closest(".b-finder__col"),m=f.closest(".b-finder__cols"),g=m.closest(".b-finder"),i=g.data("params"),g=g.data("handlers"),h=i.finder_multiple&&d.ctrlKey||i.finder_multiple&&d.metaKey?!1:!0,k=m.data("scroll"),f=f.data("level")-0+1,j=c.hasClass("b-finder__row_selected_yes")?"cancel":"approve",e=e.data("id"),p=c.data("id");c.data("row"); k&&clearTimeout(k);g.dblclick&&(h&&"approve"==j&&m.data("clear",!0),"cancel"==j&&a.addClass("b-finder__row_cancel_yes"),a.addClass("b-finder__row_loading_yes"),g.dblclick.call(this,d,{id:p,pid:e,next:f,name:c.text(),action:j,expandable:c.hasClass("b-finder__row_expandable_yes")?!0:!1},i,{hide:b.proxy(r,m.closest(".b-finder")),done:b.proxy(D,this),undone:b.proxy(E,this)}))}function z(d,a){var c=this.hasClass("b-finder__cols_mode_search")?"search":"watch",e=b(q.call("search"==c?b(".b-finder__found", this):this,"last")),f=null;if("top"==a)f=e.prev();else if("bottom"==a)f=e.next();else if("watch"==c&&e.hasClass("b-finder__row_expandable_yes")&&"right"==a||"watch"==c&&"left"==a&&"root"!=e.data("pid"))"right"==a?f=b(q.call(b(".b-finder__group_expanded_yes:last",this),"first")):(e.removeClass("b-finder__row_expanded_yes"),f=b(".b-finder__row_id_"+e.data("pid"),this));this.data("prescroll",!0);f&&0<f.length&&i.call(f.get(0),d,!0)}function q(d){var d=d||"first",a=null;(a=b(".b-finder__row_expanded_yes:"+ d,this).get(0))||(a=this.hasClass("b-finder__group")||this.hasClass("b-finder__found")?b(".b-finder__row",this).get(0):b(".b-finder__group_id_root .b-finder__row:"+d,this).get(0));return a}function D(){var d=b(this),a=d.closest(".b-finder__cols"),c=a.data("clear"),e=d.data("row");c&&(b(".b-finder__row_selected_yes",a).removeClass("b-finder__row_selected_yes"),a.removeData("clear"));d.hasClass("b-finder__row_cancel_yes")?(d.removeClass("b-finder__row_selected_yes"),e&&b(e).removeClass("b-finder__row_selected_yes")): (d.addClass("b-finder__row_selected_yes"),e&&b(e).addClass("b-finder__row_selected_yes"));d.removeClass("b-finder__row_loading_yes").removeClass("b-finder__row_cancel_yes");i.call(this,null,!0)}function E(){this.removeClass("b-finder__row_loading_yes");i.call(this,null,!0)}function w(){var d=b(this),a=b(".b-finder__cols_active_yes",d.closest(".b-finder__window")),c=null,e=null,f=b(".b-finder__found",a).empty(),i=0,g=0,o="",h="";a.removeClass("b-finder__cols_mode_watch").addClass("b-finder__cols_mode_search").scrollLeft(0); d.hasClass("b-finder__field")?(h=d.val(),g=h.length,e=0<g?b('.b-finder__row[data-search^="'+h.toLowerCase()+'"],.b-finder__row[data-search*=" '+h.toLowerCase()+'"]',a):b(".b-finder__row",a)):e=b(".b-finder__row_selected_yes",a);e&&0<e.length&&e.each(function(){c=b(this).clone().removeClass("b-finder__row_expandable_yes").removeClass("b-finder__row_expanded_yes").removeClass("b-finder__row_loading_yes").data("row",this);0==i&&c.addClass("b-finder__row_expanded_yes");0<g&&c.html(c.text().replace(RegExp("(^| )("+ h+")","i"),'$1<span class="b-finder__highlight">$2</span>'));(o=b(".b-finder__group .b-finder__row_id_"+b(this).data("pid"),a).text())&&c.prepend(o+" > ");f.append(c);i++})}function s(d){var a=b(this).closest(".b-finder"),a=b(".b-finder__window",a),c=b(".b-finder__cols_active_yes",a),e=null;c.removeClass("b-finder__cols_mode_search").addClass("b-finder__cols_mode_watch");b(".b-finder__found",c).empty();b(".b-finder__field",a).val("").blur();b(".b-finder__filter",a).removeClass("b-finder__filter_active_yes"); e=q.call(c,"last");i.call(e,d)}b.fn.finder=function(d,a,c){var c=c||{},a=a||{items_load:function(){return[]}},b=this;c.finder_id=d;if(0==b.length||!b.hasClass("b-finder"))b=A.call(b);b.hasClass("b-finder_hidden_yes")?(b.data("params",c),b.data("handlers",a),y.call(b),b.focus()):r.call(b);return this}})(jQuery);