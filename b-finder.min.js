/**
 * b-finder script
 *
 * @version 3.0
 * @author  Shushik <silkleopard@yandex.ru>
 * @page    http://github.com/Shushik/b-finder
 *
 * @requires jQuery 1.6+
 */
;(function(c){function A(){var d=c(document),b=null,a=this.data("params"),e=this.data("handlers");a.finder_static&&this.addClass("b-finder_static_yes");b=c(".b-finder__cols_id_"+a.finder_id,this);d.bind("keydown.finder_keydown",function(a){var b=c(".b-finder"),d=c(".b-finder__cols_active_yes"),e=d.hasClass("b-finder__cols_mode_search")?"search":"watch",g=a.keyCode,h={38:"top",39:"right",40:"bottom",37:"left"};h[g]?(a.preventDefault(),B.call(d,a,h[g])):190==g&&a.ctrlKey||190==g&&a.metaKey?c(".b-finder__field", b).focus():13==g?s.call(q.call(d,"search"==e?"first":"last"),a):27==g&&"search"==e?(a.stopPropagation(),r.call(d.get(0),a)):27==g&&o.call(b)});c(".b-finder__hat",this).html(a.finder_lang&&a.finder_lang.hat?a.finder_lang.hat:"&nbsp;");c(".b-finder__hint",this).html(a.finder_lang&&a.finder_lang.hint?a.finder_lang.hint:"&nbsp;");c(".b-finder__field",this).attr("placeholder",a.finder_lang&&a.finder_lang.search?a.finder_lang.search:"");c(".b-finder__filter",this).attr("title",a.finder_lang&&a.finder_lang.selected? a.finder_lang.selected:"");0!=b.length?t.call(b):a.finder_async?e.load.call(this,a,{done:c.proxy(u,this)}):b=u.call(this,e.load.call(this,a))}function o(){var d=this.data("params"),b=this.data("handlers");c(document).unbind("keydown.finder_keydown");this.addClass("b-finder_hidden_yes").removeClass("b-finder_static_yes");c(".b-finder__cols_active_yes",this).removeClass("b-finder__cols_active_yes");b.hide&&b.hide.call(this,d)}function C(){var d=c(this),b=c('<table class="b-finder b-finder_hidden_yes"><tr><td class="b-finder__valign"><div class="b-finder__window"><div class="b-finder__search"><div class="b-finder__filter"></div><div class="b-finder__clear">\u00d7</div><input class="b-finder__field" autocomplete="off" ></div><div class="b-finder__hide">\u00d7</div><div class="b-finder__hat"></div><div class="b-finder__hint"></div></div></td></tr></table>'), a=c(".b-finder__window",b),e=c(".b-finder__hide",a);0<d.length?d.replaceWith(b):c("body").append(b);b.click(function(){o.call(c(this))});e.click(function(){o.call(c(this).closest(".b-finder"))});a.click(function(a){a.stopPropagation()});a.delegate(".b-finder__field","keydown",function(a){var b=c(this),d=b.data("search"),a=a.keyCode;d&&clearTimeout(d);b.hasClass("b-finder__field")&&(40==a?b.blur():27!=a&&b.data("b_finder_search",setTimeout(c.proxy(v,this),300)))});a.delegate(".b-finder__filter","click", function(a){var b=c(this);b.hasClass("b-finder__filter_active_yes")?(b.removeClass("b-finder__filter_active_yes"),r.call(this,a)):(b.addClass("b-finder__filter_active_yes"),v.call(this))});a.delegate(".b-finder__clear","click",r);a.delegate(".b-finder__row","click",function(a){i.call(this,a,!0)});a.delegate(".b-finder__row","dblclick",function(a){s.call(this,a)});return b}function t(){var c=this.closest(".b-finder"),b=c.data("handlers"),a=c.data("params"),e=null;this.data("prescroll",!0);e=q.call(this); i.call(e,null,!0);c.removeClass("b-finder_hidden_yes");b.show&&b.show.call(c,a)}function u(d){var b=4,a=0,e=0,e=c(".b-finder__hat",this),f=c('<div class="b-finder__cols"></div>'),m=c('<div class="b-finder__scroll"></div>'),j=c('<div class="b-finder__found"></div>'),k={},g={},h=this.data("params");this.data("handlers");var l,o,p,i,n;if(h.finder_cols&&5>h.finder_cols&&0<h.finder_cols)b=h.finder_cols;e.after(f.addClass("b-finder__cols_id_"+h.finder_id).addClass("b-finder__cols_x_"+b).addClass("b-finder__cols_mode_watch")); f.append(m);e=d.length;for(i=0;i<e;i++){n=d[i];p=n.level;o=n.name;l="root";b=n.id;if(n.parentId)l=n.parentId;else if(n.parent_id)l=n.parent_id;else if(n.pid)l=n.pid;k[p]||(k[p]=w.call(m,p),a<p&&(a=p));g[l]||(g[l]=D.call(k[p],l));l=E.call(g[l],b,l,o);h.finder_selected&&-1!=c.inArray(b,h.finder_selected)&&l.addClass("b-finder__row_expanded_yes").addClass("b-finder__row_selected_yes")}for(i in g)c(".b-finder__row_id_"+g[i].data("id"),f).addClass("b-finder__row_expandable_yes");c(".b-finder__col_level_1", f).append(j);h.finder_holder||w.call(m,a+1);t.call(f)}function w(d){var d=c('<div class="b-finder__col"></div>').addClass("b-finder__col_level_"+d).data("level",d),b=this.css("width").replace("px","")-0;this.append(d);b+=d.css("width").replace("px","")-0+(d.css("margin-right").replace("px","")-0)+(d.css("margin-left").replace("px","")-0);this.css("width",b+"px");return d}function x(d){var b=c(this),a=b.closest(".b-finder__col");"watch"==d&&a.scrollTop(b.offset().top-b.closest(".b-finder__group").offset().top)} function D(d){var b=c('<div class="b-finder__group b-finder__group_id_'+d+'"></div>').data("id",d);"root"==d&&b.addClass("b-finder__group_expanded_yes");this.append(b);return b}function E(d,b,a){d=c('<div class="b-finder__row b-finder__row_id_'+d+'"></div>').text(a).attr("data-search",a.toLowerCase()).data({id:d,pid:b});this.append(d);return d}function i(d){var b=c(this),a=b.data("row"),b=a?c(a):b,e=b.closest(".b-finder__col"),f=e.closest(".b-finder"),m=b.hasClass("b-finder__row_expandable_yes")? !0:!1,j=b.data("id"),k=b.data("pid"),e=e.data("level"),g=f.data("params"),h=f.data("handlers");h.click&&!a&&h.click.call(this,d,{id:j,pid:k,next:e+1,name:b.text(),expandable:m},b.closest(".b-finder").data("params"),{hide:c.proxy(o,f),done:c.proxy(y,this),undone:c.proxy(z,this)});g.finder_async||y.call(this,d)}function y(){var d=c(this),b=d.data("row"),a=b?c(b):d,e=a.closest(".b-finder__col"),f=e.closest(".b-finder__cols"),m=a.hasClass("b-finder__row_expandable_yes")?!0:!1,j=a.data("id"),k=a.data("pid"), g=f.hasClass("b-finder__cols_mode_search")?"search":"watch",h=f.closest(".b-finder").data("params");f.data("stopped",j);c(".b-finder__group_expanded_yes",f).removeClass("b-finder__group_expanded_yes");c(".b-finder__row_expanded_yes",f).removeClass("b-finder__row_expanded_yes");m&&c(".b-finder__group_id_"+j,f).addClass("b-finder__group_expanded_yes");f.addClass("b-finder__cols_active_yes");d.addClass("b-finder__row_expanded_yes");b&&a.addClass("b-finder__row_expanded_yes");if("watch"==g&&(a.closest(".b-finder__group").addClass("b-finder__group_expanded_yes"), !h||!h.finder_scroll_off))x.call(a.get(0),g),f.data("scroll_timer",setTimeout(function(){f.scrollLeft((e.css("width").replace("px","")-0+(e.css("margin-left").replace("px","")-0)+(e.css("margin-right").replace("px","")-0))*(e.data("level")-1))},200));if("watch"==g)for(;k&&"root"!=k;)a=c(".b-finder__row_id_"+k,f),j=a.data("id"),k=a.data("pid"),a.addClass("b-finder__row_expanded_yes"),a.closest(".b-finder__group").addClass("b-finder__group_expanded_yes"),(!h||!h.finder_scroll_off)&&x.call(a.get(0), g)}function s(d){var b=c(this),a=b.data("row"),a=a?c(a):b,e=a.closest(".b-finder__group"),f=a.closest(".b-finder__col"),m=f.closest(".b-finder__cols"),j=m.closest(".b-finder"),k=j.data("params"),j=j.data("handlers"),g=k.finder_multiple&&d.ctrlKey||k.finder_multiple&&d.metaKey?!1:!0,h=m.data("scroll"),f=f.data("level")-0+1,l=a.hasClass("b-finder__row_selected_yes")?"cancel":"approve",e=e.data("id"),i=a.data("id");a.data("row");h&&clearTimeout(h);j.dblclick&&(g&&"approve"==l&&m.data("clear",!0),"cancel"== l&&b.addClass("b-finder__row_cancel_yes"),b.addClass("b-finder__row_loading_yes"),j.dblclick.call(this,d,{id:i,pid:e,next:f,name:a.text(),action:l,expandable:a.hasClass("b-finder__row_expandable_yes")?!0:!1},k,{hide:c.proxy(o,m.closest(".b-finder")),done:c.proxy(F,this),undone:c.proxy(z,this)}))}function B(d,b){var a=this.hasClass("b-finder__cols_mode_search")?"search":"watch",e=c(q.call("search"==a?c(".b-finder__found",this):this,"last")),f=null;if("top"==b)f=e.prev();else if("bottom"==b)f=e.next(); else if("watch"==a&&e.hasClass("b-finder__row_expandable_yes")&&"right"==b||"watch"==a&&"left"==b&&"root"!=e.data("pid"))"right"==b?f=c(q.call(c(".b-finder__group_expanded_yes:last",this),"first")):(e.removeClass("b-finder__row_expanded_yes"),f=c(".b-finder__row_id_"+e.data("pid"),this));this.data("prescroll",!0);f&&0<f.length&&i.call(f.get(0),d,!0)}function q(d){var d=d||"first",b=this.data("stopped"),a=null;(a=b?c(".b-finder__row_id_"+b,this):c(".b-finder__row_expanded_yes:"+d,this).get(0))||(a= this.hasClass("b-finder__group")||this.hasClass("b-finder__found")?c(".b-finder__row",this).get(0):c(".b-finder__group_id_root .b-finder__row:"+d,this).get(0));return a}function F(){var d=c(this),b=d.closest(".b-finder__cols"),a=b.data("clear"),e=d.data("row");a&&(c(".b-finder__row_selected_yes",b).removeClass("b-finder__row_selected_yes"),b.removeData("clear"));d.hasClass("b-finder__row_cancel_yes")?(d.removeClass("b-finder__row_selected_yes"),e&&c(e).removeClass("b-finder__row_selected_yes")):(d.addClass("b-finder__row_selected_yes"), e&&c(e).addClass("b-finder__row_selected_yes"));d.removeClass("b-finder__row_loading_yes").removeClass("b-finder__row_cancel_yes");i.call(this,null,!0)}function z(){this.removeClass("b-finder__row_loading_yes");i.call(this,null,!0)}function v(){var d=c(this),b=c(".b-finder__cols_active_yes",d.closest(".b-finder__window")),a=null,e=null,f=c(".b-finder__found",b).empty(),i=0,j=0,k="",g="";b.removeClass("b-finder__cols_mode_watch").addClass("b-finder__cols_mode_search").scrollLeft(0);d.hasClass("b-finder__field")? (g=d.val(),j=g.length,e=0<j?c('.b-finder__row[data-search^="'+g.toLowerCase()+'"],.b-finder__row[data-search*=" '+g.toLowerCase()+'"]',b):c(".b-finder__row",b)):e=c(".b-finder__row_selected_yes",b);e&&0<e.length&&e.each(function(){a=c(this).clone().removeClass("b-finder__row_expandable_yes").removeClass("b-finder__row_expanded_yes").removeClass("b-finder__row_loading_yes").data("row",this);a.removeClass("b-finder__row_id_"+a.data("id"));0==i&&a.addClass("b-finder__row_expanded_yes");0<j&&a.html(a.text().replace(RegExp("(^| )("+ g+")","i"),'$1<span class="b-finder__highlight">$2</span>'));(k=c(".b-finder__group .b-finder__row_id_"+c(this).data("pid"),b).text())&&a.prepend(k+" > ");f.append(a);i++})}function r(d){var b=c(this).closest(".b-finder"),b=c(".b-finder__window",b),a=c(".b-finder__cols_active_yes",b),e=null;a.removeClass("b-finder__cols_mode_search").addClass("b-finder__cols_mode_watch");c(".b-finder__found",a).empty();c(".b-finder__field",b).val("").blur();c(".b-finder__filter",b).removeClass("b-finder__filter_active_yes"); e=q.call(a,"last");i.call(e,d)}c.fn.finder=function(c,b,a){var a=a||{},b=b||{items_load:function(){return[]}},e=this;a.finder_id=c;if(0==e.length||!e.hasClass("b-finder"))e=C.call(e);e.hasClass("b-finder_hidden_yes")?(e.data("params",a),e.data("handlers",b),A.call(e),e.focus()):o.call(e);return this}})(jQuery);